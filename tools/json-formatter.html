<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JSON Formatter | Tools Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/shared.css">
    <style>
        /* Shared Tool Styles */
        .calculator-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            min-height: calc(100vh - 300px);
        }

        .calculator-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 { font-size: 1.5rem; margin-bottom: 4px; }
        .panel-header p { color: var(--text-secondary); font-size: 0.9375rem; }

        /* Toolbar */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tool-btn:hover {
            border-color: var(--accent-engineering);
            background: var(--bg-card);
        }

        .tool-btn.primary {
            background: var(--accent-engineering);
            color: var(--bg-primary);
            border-color: var(--accent-engineering);
            font-weight: 600;
        }
        .tool-btn.primary:hover { opacity: 0.9; }

        .tool-btn svg { width: 14px; height: 14px; }

        /* Editor Area */
        .editor-container {
            flex: 1;
            position: relative;
            min-height: 500px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            background: var(--bg-secondary);
        }

        textarea.json-input {
            width: 100%;
            height: 100%;
            border: none;
            background: transparent;
            color: var(--text-primary);
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            resize: none;
            outline: none;
        }

        /* Syntax Highlighting Overlay */
        .json-output {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            padding: 20px;
            margin: 0;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-card);
            overflow: auto;
            white-space: pre-wrap;
            display: none; /* Hidden by default */
        }

        .json-output.active { display: block; }

        /* Syntax Colors (Custom implementation) */
        .key { color: #f87171; } /* Red-ish */
        .string { color: #34d399; } /* Green-ish */
        .number { color: #60a5fa; } /* Blue-ish */
        .boolean { color: #a78bfa; } /* Purple-ish */
        .null { color: #9ca3af; } /* Gray */

        /* Error Banner */
        .error-banner {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            color: #ef4444;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        /* Sidebar Styles */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .sidebar-card h3 {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Warning Banner */
        .warning-banner {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            color: #f59e0b; /* Amber-500 */
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            display: none;
            align-items: center;
            gap: 10px;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8125rem;
        }

        .stat-row:last-child { border-bottom: none; }
        .stat-label { color: var(--text-secondary); }
        .stat-val { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--accent-engineering); }

        /* Disclaimer Card */
        .disclaimer-card {
            background: var(--bg-card);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-left: 4px solid rgba(239, 68, 68, 0.8);
            border-radius: 8px;
            padding: 20px;
            margin-top: 24px;
        }
        .disclaimer-title {
            display: flex; align-items: center; gap: 10px;
            font-family: 'Space Grotesk', sans-serif; font-weight: 700;
            color: #ef4444; text-transform: uppercase; letter-spacing: 0.05em;
            margin-bottom: 12px;
        }
        .disclaimer-content { font-size: 0.875rem; color: var(--text-secondary); line-height: 1.6; }
        .disclaimer-list { margin: 12px 0; padding-left: 20px; }
        .disclaimer-list li { margin-bottom: 6px; }
        .disclaimer-footer {
            margin-top: 16px; font-size: 0.75rem; color: var(--text-muted);
            border-top: 1px solid var(--border-color); padding-top: 12px;
            font-family: 'JetBrains Mono', monospace;
        }

        @media (max-width: 1024px) {
            .calculator-layout { grid-template-columns: 1fr; }
            .editor-container { min-height: 400px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <a href="../tools.html" class="back-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        Back to Tools
                    </a>
                </div>
                <div class="header-right">
                    <div class="theme-toggle">
                        <button data-theme-toggle="light" aria-pressed="false" title="Light mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/>
                                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                            </svg>
                        </button>
                        <button data-theme-toggle="dark" aria-pressed="false" title="Dark mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 24px; display: flex; align-items: center; gap: 16px;">
                <div class="tool-icon-header engineering">{}</div>
                <div>
                    <h1>JSON Formatter</h1>
                    <p class="tagline">// PARSE • VALIDATE • MINIFY</p>
                </div>
            </div>
        </header>

        <main>
            <div class="calculator-layout">
                <div class="calculator-panel">
                    <div class="panel-header">
                        <h2>Input Data</h2>
                        <p>Paste your JSON below to format, validate, or minify.</p>
                    </div>

                    <div class="error-banner" id="errorBanner">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="8" x2="12" y2="12"/>
                            <line x1="12" y1="16" x2="12.01" y2="16"/>
                        </svg>
                        <span id="errorText">Invalid JSON</span>
                    </div>

                    <div class="warning-banner" id="warningBanner">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span id="warningText">Warning: Large integers detected. Precision may be lost.</span>
                    </div>

                    <div class="success-banner" id="successBanner" style="
                        background: rgba(34, 197, 94, 0.1);
                        border: 1px solid rgba(34, 197, 94, 0.3);
                        color: #22c55e;
                        padding: 12px;
                        border-radius: 6px;
                        margin-bottom: 16px;
                        font-family: 'JetBrains Mono', monospace;
                        font-size: 0.8125rem;
                        display: none;
                        align-items: center;
                        gap: 10px;">
                        <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2">
                            <polyline points="20 6 9 17 4 12"/>
                        </svg>
                        <span>Valid JSON ✓</span>
                    </div>

                    <div class="toolbar">
                        <button class="tool-btn primary" onclick="formatJSON()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 14 10 14 10 20"/>
                                <polyline points="20 10 14 10 14 4"/>
                                <line x1="14" y1="10" x2="21" y2="3"/>
                                <line x1="3" y1="21" x2="10" y2="14"/>
                            </svg>
                            Format
                        </button>
                        <button class="tool-btn" onclick="minifyJSON()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="4 7 4 4 20 4 20 7"/>
                                <line x1="9" y1="20" x2="15" y2="20"/>
                                <line x1="12" y1="4" x2="12" y2="20"/>
                            </svg>
                            Minify
                        </button>
                        <button class="tool-btn" onclick="copyResult()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
                            </svg>
                            Copy
                        </button>
                        <button class="tool-btn" onclick="clearEditor()" style="margin-left: auto; color: #ef4444; border-color: rgba(239,68,68,0.3);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="3 6 5 6 21 6"/>
                                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Clear
                        </button>
                    </div>

                    <div class="editor-container">
                        <textarea id="inputArea" class="json-input" placeholder="// Paste JSON here..." spellcheck="false"></textarea>
                        <pre id="outputArea" class="json-output"></pre>
                    </div>
                </div>

                <aside class="sidebar">
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                <line x1="8" y1="21" x2="16" y2="21"/>
                                <line x1="12" y1="17" x2="12" y2="21"/>
                            </svg>
                            Data Stats
                        </h3>
                        <div class="stat-row">
                            <span class="stat-label">Size (Bytes)</span>
                            <span class="stat-val" id="statSize">0 B</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total Keys</span>
                            <span class="stat-val" id="statKeys">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Arrays</span>
                            <span class="stat-val" id="statArrays">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Depth</span>
                            <span class="stat-val" id="statDepth">0</span>
                        </div>
                    </div>

                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                            Quick Actions
                        </h3>
                        <button class="tool-btn" onclick="loadSample()" style="width: 100%; justify-content: center; margin-bottom: 8px;">
                            Load Sample Data
                        </button>
                        <button class="tool-btn" onclick="editMode()" id="editBtn" style="width: 100%; justify-content: center; display: none;">
                            Return to Edit
                        </button>
                    </div>

                    <div class="disclaimer-card">
                        <div class="disclaimer-title">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                                <line x1="12" y1="9" x2="12" y2="13"/>
                                <line x1="12" y1="17" x2="12.01" y2="17"/>
                            </svg>
                            Critical Engineering Disclaimer
                        </div>
                        <div class="disclaimer-content">
                            <p style="margin-bottom: 8px;"><strong>Data Integrity Warning.</strong> This tool runs entirely in your browser, but be aware of JavaScript limitations:</p>
                            <ul class="disclaimer-list">
                                <li><strong>64-bit Integers:</strong> Standard JS `JSON.parse` treats numbers as IEEE 754 doubles. Integers larger than 2⁵³-1 (e.g. some Database IDs, Twitter Snowflakes) <strong>will lose precision</strong>.</li>
                                <li><strong>Privacy:</strong> While this does not upload data, avoid pasting production credentials or PII into any web-based clipboard.</li>
                                <li><strong>BigInt:</strong> Native JSON spec does not support BigInt literals (e.g. `123n`). They will cause parse errors.</li>
                            </ul>
                            <p class="disclaimer-footer">
                                PROVIDED "AS IS" WITH NO WARRANTY. NOT SUITABLE FOR VALIDATING CRITICAL FINANCIAL LEDGERS OR CRYPTOGRAPHIC KEYS.
                            </p>
                        </div>
                    </div>
                </aside>
            </div>
        </main>

        <footer data-footer></footer>
    </div>

    <script src="../js/shared.js"></script>
    <script src="../js/footer.js"></script>
    <script>
        // ============================================
        // JSON Logic
        // ============================================

        const inputArea = document.getElementById('inputArea');
        const outputArea = document.getElementById('outputArea');
        
        // Banners
        const errorBanner = document.getElementById('errorBanner');
        const errorText = document.getElementById('errorText');
        const warningBanner = document.getElementById('warningBanner');
        const warningText = document.getElementById('warningText');
        
        const editBtn = document.getElementById('editBtn');

        // Stats Elements
        const stats = {
            size: document.getElementById('statSize'),
            keys: document.getElementById('statKeys'),
            arrays: document.getElementById('statArrays'),
            depth: document.getElementById('statDepth')
        };

        // Real-time stat update
        let timeout;
        inputArea.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                // Clear banners on type
                errorBanner.style.display = 'none';
                warningBanner.style.display = 'none';
                
                updateStats(inputArea.value);
            }, 500);
        });

        function formatJSON() {
            processJSON(true);
        }

        function minifyJSON() {
            processJSON(false);
        }

        function processJSON(pretty) {
            try {
                const raw = inputArea.value;
                if (!raw.trim()) {
                    showError(new Error("Input is empty"));
                    return;
                }

                // 1. Check for Precision Loss BEFORE parsing
                // This is critical because JSON.parse is destructive
                checkPrecisionLoss(raw);

                // 2. Parse & Transform
                const obj = JSON.parse(raw);
                const formatted = pretty ? JSON.stringify(obj, null, 2) : JSON.stringify(obj);
                
                // 3. Update UI
                if (pretty) {
                    inputArea.style.display = 'none';
                    outputArea.innerHTML = syntaxHighlight(formatted);
                    outputArea.classList.add('active');
                } else {
                    outputArea.classList.remove('active');
                    inputArea.style.display = 'block';
                    inputArea.value = formatted;
                }
                
                editBtn.style.display = pretty ? 'flex' : 'none';
                errorBanner.style.display = 'none';
                
                // Update stats synchronously (no delay)
                updateStats(formatted);

            } catch (e) {
                showError(e);
            }
        }

        function checkPrecisionLoss(raw) {
            // We need to find large integers BEFORE JSON.parse destroys them
            // Strategy: Find number sequences with 15+ digits in valid JSON positions
            
            // Pattern breakdown:
            // (?:^|[:\[,\s]) - Start of string, or after : [ , or whitespace
            // (-?\d{15,}) - Capture negative or positive integers with 15+ digits
            // (?=[,\]\}\s]|$) - Followed by , ] } whitespace or end of string
            const unsafePattern = /(?:^|[:\[,\s])(-?\d{15,})(?=[,\]\}\s]|$)/g;
            
            let match;
            let hasIssue = false;
            const problematicNumbers = [];

            while ((match = unsafePattern.exec(raw)) !== null) {
                const numStr = match[1];
                
                // JavaScript's Number can safely represent integers up to 2^53 - 1
                // That's 9007199254740991 (16 digits)
                // Anything larger will lose precision
                
                try {
                    const asNumber = Number(numStr);
                    
                    // Primary check: explicitly verify against MAX_SAFE_INTEGER
                    // This catches 9007199254740992 and above
                    if (Math.abs(asNumber) > Number.MAX_SAFE_INTEGER) {
                        hasIssue = true;
                        problematicNumbers.push(numStr);
                        continue;
                    }
                    
                    // Secondary check: round-trip test for edge cases
                    // This catches cases where string conversion differs
                    const backToString = asNumber.toString();
                    if (backToString !== numStr) {
                        hasIssue = true;
                        problematicNumbers.push(numStr);
                    }
                    
                } catch (e) {
                    // If we can't parse it, let the main JSON.parse handle the error
                    continue;
                }
            }

            if (hasIssue) {
                warningBanner.style.display = 'flex';
                
                // More detailed warning message
                if (problematicNumbers.length === 1) {
                    warningText.textContent = `Warning: Large integer detected (${problematicNumbers[0]}...). JavaScript has rounded this value.`;
                } else if (problematicNumbers.length <= 3) {
                    warningText.textContent = `Warning: ${problematicNumbers.length} large integers detected. JavaScript has rounded these values.`;
                } else {
                    warningText.textContent = `Warning: ${problematicNumbers.length} large integers detected. JavaScript has rounded these values.`;
                }
            } else {
                warningBanner.style.display = 'none';
            }
        }

        function editMode() {
            outputArea.classList.remove('active');
            inputArea.style.display = 'block';
            editBtn.style.display = 'none';
            // Sync content if needed (optional)
        }

        function clearEditor() {
            inputArea.value = '';
            outputArea.innerHTML = '';
            outputArea.classList.remove('active');
            inputArea.style.display = 'block';
            errorBanner.style.display = 'none';
            warningBanner.style.display = 'none';
            editBtn.style.display = 'none';
            updateStats('');
        }

        function loadSample() {
            // Use raw string literal to avoid JavaScript number parsing
            // This preserves the exact integer value as it would appear in JSON
            const sampleStr = `{
        "project": "Tools Hub",
        "version": "1.0.0",
        "active": true,
        "config": {
            "maxRetries": 3,
            "timeout": 5000
        },
        "users": [
            {
            "id": 101,
            "name": "Alice",
            "role": "admin"
            },
            {
            "id": 9223372036854775807,
            "name": "BigInt_User",
            "role": "tester",
            "note": "This ID exceeds JavaScript's MAX_SAFE_INTEGER (2^53-1)"
            }
        ],
        "statistics": {
            "totalUsers": 2,
            "activeToday": 1
        }
        }`;
            
            inputArea.value = sampleStr;
            editMode();
            updateStats(inputArea.value);
        }


        function copyResult() {
            const text = outputArea.classList.contains('active') ? outputArea.innerText : inputArea.value;
            
            // Check if there's any text to copy
            if (!text || !text.trim()) {
                alert('Nothing to copy! Please enter some JSON first.');
                return;
            }
            
            // Helper to show success animation
            const showSuccess = () => {
                const copyBtn = document.querySelector('.tool-btn[onclick="copyResult()"]');
                if (!copyBtn) return;
                
                const originalHtml = copyBtn.innerHTML;
                const originalStyle = {
                    borderColor: copyBtn.style.borderColor,
                    color: copyBtn.style.color
                };

                copyBtn.innerHTML = `
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"/>
                    </svg>
                    Copied!
                `;
                copyBtn.style.borderColor = '#22c55e';
                copyBtn.style.color = '#22c55e';
                
                setTimeout(() => {
                    copyBtn.innerHTML = originalHtml;
                    copyBtn.style.borderColor = originalStyle.borderColor;
                    copyBtn.style.color = originalStyle.color;
                }, 2000);
            };

            // 1. Try Modern Async API
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(showSuccess)
                    .catch(err => {
                        console.warn('Clipboard API failed, trying fallback...', err);
                        fallbackCopy(text);
                    });
            } else {
                // 2. Immediate Fallback for older browsers / non-secure contexts
                fallbackCopy(text);
            }

            // Fallback Method: Create hidden textarea -> Select -> ExecCommand
            function fallbackCopy(textToCopy) {
                try {
                    const textArea = document.createElement("textarea");
                    textArea.value = textToCopy;
                    
                    // Ensure it's not visible but part of the DOM
                    textArea.style.position = "fixed";
                    textArea.style.left = "-9999px";
                    textArea.style.top = "0";
                    document.body.appendChild(textArea);
                    
                    textArea.focus();
                    textArea.select();
                    
                    const successful = document.execCommand('copy');
                    document.body.removeChild(textArea);
                    
                    if (successful) {
                        showSuccess();
                    } else {
                        throw new Error('execCommand returned false');
                    }
                } catch (err) {
                    console.error('Fallback copy failed:', err);
                    alert('Failed to copy to clipboard. Please try selecting and copying manually.');
                }
            }
        }

        function showError(e) {
            let msg = e.message;
            const hint = detectCommonErrors(inputArea.value);
            if (hint) msg += ` — ${hint}`;
            
            errorText.textContent = msg;
            
            // Make sure we're in edit mode first
            editMode();
            
            // Ensure error banner is visible (force show after edit mode)
            errorBanner.style.display = 'flex';
            // Hide warning if we have an error (error is more important)
            warningBanner.style.display = 'none';
            
            // Scroll error into view if needed
            errorBanner.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        function detectCommonErrors(raw) {
            // Trailing comma
            if (/,\s*[\]}]/.test(raw)) {
                return "Trailing comma detected (not allowed in JSON)";
            }
            
            // Single quotes instead of double quotes
            if (/'[^']*'\s*:/.test(raw) || /:\s*'[^']*'/.test(raw)) {
                return "Single quotes detected (JSON requires double quotes)";
            }
            
            // Unquoted keys
            if (/(?:^|[{,])\s*([a-zA-Z_$][a-zA-Z0-9_$]*)\s*:/.test(raw)) {
                return "Unquoted key detected (all keys must be quoted)";
            }
            
            // Comments (not allowed in JSON)
            if (/\/\/|\/\*/.test(raw)) {
                return "Comments detected (not allowed in standard JSON)";
            }
            
            // NaN or Infinity (not valid JSON)
            if (/\b(NaN|Infinity|-Infinity)\b/.test(raw)) {
                return "NaN/Infinity detected (not valid JSON values)";
            }
            
            // Undefined
            if (/\bundefined\b/.test(raw)) {
                return "undefined detected (use null instead)";
            }
            
            return null;
        }

        // --- Logic & Stats ---

        function updateStats(jsonStr) {
            if (!jsonStr) {
                resetStats();
                return;
            }
            const size = new Blob([jsonStr]).size;
            stats.size.textContent = formatBytes(size);

            try {
                const obj = JSON.parse(jsonStr);
                const metrics = analyzeJSON(obj);
                stats.keys.textContent = metrics.keys;
                stats.arrays.textContent = metrics.arrays;
                stats.depth.textContent = metrics.depth;
            } catch (e) {
                // Ignore stats update on invalid JSON
            }
        }

        function analyzeJSON(obj) {
            let keys = 0;
            let arrays = 0;
            let maxDepth = 0;
            function traverse(o, depth) {
                if (depth > maxDepth) maxDepth = depth;
                if (Array.isArray(o)) {
                    arrays++;
                    o.forEach(item => traverse(item, depth + 1));
                } else if (typeof o === 'object' && o !== null) {
                    keys += Object.keys(o).length;
                    Object.values(o).forEach(val => traverse(val, depth + 1));
                }
            }
            traverse(obj, 1);
            return { keys, arrays, depth: maxDepth };
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function resetStats() {
            stats.size.textContent = '0 B';
            stats.keys.textContent = '0';
            stats.arrays.textContent = '0';
            stats.depth.textContent = '0';
        }

        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'number';
                if (/^"/.test(match)) {
                    cls = /:$/.test(match) ? 'key' : 'string';
                } else if (/true|false/.test(match)) {
                    cls = 'boolean';
                } else if (/null/.test(match)) {
                    cls = 'null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        function validateAndShowFeedback() {
            // This can be called on successful parse to show "Valid JSON ✓"
            const successBanner = document.getElementById('successBanner'); 
            if (successBanner) {
                successBanner.style.display = 'flex';
                setTimeout(() => {
                    successBanner.style.display = 'none';
                }, 3000);
            }
        }
    </script>
</body>
</html>