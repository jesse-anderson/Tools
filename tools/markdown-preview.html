<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Markdown Preview | Tools Hub</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/shared.css">
    <!-- Prism.js syntax highlighting theme-->
    <link rel="stylesheet" href="../css/Markdown/prism-tomorrow.min.css" />
    
    <style>
        /* ============================================
           MARKDOWN PREVIEW - TOOL-SPECIFIC STYLES
           ============================================ 
           
           TODO:
            Likely more exports, everything else is performant. More interoperability would be nice, like a docx or email styled message.
           */

        /* Calculator Layout */
        .calculator-layout {
            display: grid;
            grid-template-columns: 1fr 320px;
            gap: 24px;
            min-height: calc(100vh - 300px);
        }

        .calculator-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .panel-header h2 { font-size: 1.5rem; margin-bottom: 4px; }
        .panel-header p { color: var(--text-secondary); font-size: 0.9375rem; }

        /* Tool Icon Header */
        .tool-icon-header {
            width: 48px;
            height: 48px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .tool-icon-header.it {
            background: var(--accent-it-dim);
            color: var(--accent-it);
        }

        /* Back Link */
        .back-link {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.15s ease;
        }

        .back-link:hover {
            color: var(--accent-it);
        }

        .back-link svg {
            width: 16px;
            height: 16px;
        }

        /* Usage Banner */
        .info-banner {
            background: rgba(6, 182, 212, 0.1);
            border: 1px solid rgba(6, 182, 212, 0.2);
            color: var(--accent-it);
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .info-banner svg {
            flex-shrink: 0;
        }

        /* Warning Banner */
        .warning-banner {
            background: var(--accent-warning-dim);
            border: 1px solid rgba(234, 179, 8, 0.3);
            color: var(--accent-warning);
            padding: 10px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 0.8125rem;
            display: flex;
            align-items: center;
            gap: 10px;
            font-family: 'Space Grotesk', sans-serif;
        }

        .warning-banner.hidden {
            display: none;
        }

        /* Toolbar */
        .toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 16px;
            align-items: center;
        }

        .toolbar-group {
            display: flex;
            gap: 6px;
            align-items: center;
        }

        .tool-btn {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tool-btn:hover:not(:disabled) {
            border-color: var(--accent-it);
            background: var(--bg-card);
        }

        .tool-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tool-btn.danger {
            color: var(--accent-error);
            border-color: rgba(239, 68, 68, 0.3);
        }

        .tool-btn.danger:hover:not(:disabled) {
            border-color: var(--accent-error);
            background: var(--accent-error-dim);
        }

        .tool-btn svg {
            width: 14px;
            height: 14px;
            flex-shrink: 0;
        }

        /* Toolbar Separator */
        .tool-sep {
            width: 1px;
            height: 24px;
            background: var(--border-color);
            margin: 0 4px;
        }

        /* Mode Toggle (Segmented Control) */
        .mode-toggle {
            display: flex;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .mode-toggle button {
            padding: 8px 10px;
            background: transparent;
            border: none;
            color: var(--text-secondary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            cursor: pointer;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .mode-toggle button:hover {
            color: var(--text-primary);
        }

        .mode-toggle button.active {
            background: var(--accent-it);
            color: var(--bg-primary);
        }

        /* Live Preview Toggle */
        .toggle-switch {
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .toggle-switch input[type="checkbox"] {
            width: 36px;
            height: 20px;
            appearance: none;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }

        .toggle-switch input[type="checkbox"]::before {
            content: '';
            position: absolute;
            width: 14px;
            height: 14px;
            background: var(--text-muted);
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: all 0.2s;
        }

        .toggle-switch input[type="checkbox"]:checked {
            background: var(--accent-it);
            border-color: var(--accent-it);
        }

        .toggle-switch input[type="checkbox"]:checked::before {
            background: white;
            left: 18px;
        }

        /* Insert Dropdown */
        .dropdown {
            position: relative;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            margin-top: 4px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 8px;
            min-width: 220px;
            z-index: 100;
            display: none;
            box-shadow: var(--shadow-lg);
        }

        .dropdown-menu.active {
            display: block;
        }

        .dropdown-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8125rem;
            color: var(--text-primary);
            transition: background 0.15s;
        }

        .dropdown-item:hover {
            background: var(--bg-secondary);
        }

        .dropdown-item code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.6875rem;
            color: var(--text-muted);
            background: var(--bg-secondary);
            padding: 2px 6px;
            border-radius: 3px;
        }

        /* Workspace (Editor + Preview) */
        .workspace {
            display: flex;
            gap: 0;
            flex: 1;
            min-height: 500px;
        }

        .editor-pane, .preview-pane {
            display: flex;
            flex-direction: column;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            overflow: hidden;
            flex: 1;
            min-width: 200px;
        }

        .pane-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .pane-header .pane-title {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pane-header svg {
            width: 14px;
            height: 14px;
        }

        /* Editor Textarea */
        #editor {
            flex: 1;
            width: 100%;
            background: transparent;
            border: none;
            padding: 16px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            color: var(--text-primary);
            resize: none;
            outline: none;
            line-height: 1.7;
        }

        #editor::placeholder {
            color: var(--text-muted);
        }

        /* Preview Container */
        .preview-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            font-family: 'Space Grotesk', sans-serif;
            font-size: 0.9375rem;
            line-height: 1.7;
            color: var(--text-primary);
        }

        /* Markdown Preview Styles */
        .preview-container h1,
        .preview-container h2,
        .preview-container h3,
        .preview-container h4,
        .preview-container h5,
        .preview-container h6 {
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-weight: 600;
            line-height: 1.3;
        }

        .preview-container h1:first-child,
        .preview-container h2:first-child,
        .preview-container h3:first-child {
            margin-top: 0;
        }

        .preview-container h1 { font-size: 1.75rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .preview-container h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
        .preview-container h3 { font-size: 1.25rem; }
        .preview-container h4 { font-size: 1.1rem; }

        .preview-container p {
            margin: 0 0 1em 0;
        }

        .preview-container a {
            color: var(--accent-it);
            text-decoration: none;
        }

        .preview-container a:hover {
            text-decoration: underline;
        }

        .preview-container code {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875em;
            background: var(--bg-card);
            padding: 0.2em 0.4em;
            border-radius: 4px;
            border: 1px solid var(--border-color);
        }

        .preview-container pre {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 16px;
            overflow-x: auto;
            margin: 1em 0;
        }

        .preview-container pre code {
            background: none;
            border: none;
            padding: 0;
            font-size: 0.8125rem;
        }

        .preview-container blockquote {
            margin: 1em 0;
            padding: 0.5em 1em;
            border-left: 4px solid var(--accent-it);
            background: var(--bg-card);
            color: var(--text-secondary);
        }

        .preview-container blockquote p:last-child {
            margin-bottom: 0;
        }

        .preview-container ul,
        .preview-container ol {
            margin: 1em 0;
            padding-left: 2em;
        }

        .preview-container li {
            margin: 0.25em 0;
        }

        .preview-container input[type="checkbox"] {
            margin-right: 0.5em;
            pointer-events: none;
        }

        .preview-container table {
            width: 100%;
            border-collapse: collapse;
            margin: 1em 0;
        }

        .preview-container th,
        .preview-container td {
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            text-align: left;
        }

        .preview-container th {
            background: var(--bg-card);
            font-weight: 600;
        }

        .preview-container tr:nth-child(even) {
            background: var(--bg-card);
        }

        .preview-container img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 1em 0;
        }

        .preview-container hr {
            border: none;
            border-top: 1px solid var(--border-color);
            margin: 2em 0;
        }

        .preview-container del,
        .preview-container s {
            text-decoration: line-through;
            color: var(--text-muted);
        }

        .preview-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .preview-placeholder svg {
            width: 48px;
            height: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Sidebar */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .sidebar-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
        }

        .sidebar-card h3 {
            font-size: 0.875rem;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-card h3 svg {
            width: 16px;
            height: 16px;
            color: var(--accent-it);
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.8125rem;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: var(--text-secondary);
        }

        .stat-val {
            font-family: 'JetBrains Mono', monospace;
            font-weight: 600;
            color: var(--accent-it);
        }

        /* Images Card */
        .image-upload-zone {
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .image-upload-zone:hover,
        .image-upload-zone.drag-over {
            border-color: var(--accent-it);
            background: var(--accent-it-dim);
        }

        .image-upload-zone svg {
            width: 24px;
            height: 24px;
            color: var(--text-muted);
            margin-bottom: 8px;
        }

        .image-upload-zone p {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin: 0;
        }

        .image-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 200px;
            overflow-y: auto;
        }

        .image-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
        }

        .image-item img {
            width: 40px;
            height: 40px;
            object-fit: cover;
            border-radius: 4px;
        }

        .image-item-info {
            flex: 1;
            min-width: 0;
        }

        .image-item-name {
            font-size: 0.75rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-item-size {
            font-size: 0.6875rem;
            color: var(--text-muted);
        }

        .image-item-actions {
            display: flex;
            gap: 4px;
        }

        .image-item-btn {
            padding: 4px 8px;
            font-size: 0.625rem;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .image-item-btn:hover {
            border-color: var(--accent-it);
            color: var(--text-primary);
        }

        .image-item-btn.delete:hover {
            border-color: var(--accent-error);
            color: var(--accent-error);
        }

        .storage-info {
            font-size: 0.6875rem;
            color: var(--text-muted);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px dashed var(--border-color);
        }

        /* Status Card */
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--accent-success);
        }

        .status-dot.warning {
            background: var(--accent-warning);
        }

        .status-dot.error {
            background: var(--accent-error);
        }

        .status-text {
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .status-time {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .status-btn {
            width: 100%;
            padding: 8px;
            font-size: 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s;
        }

        .status-btn:hover {
            border-color: var(--accent-error);
            color: var(--accent-error);
        }

        /* Disclaimer Card */
        .disclaimer-card {
            background: var(--bg-card);
            border: 1px solid rgba(6, 182, 212, 0.4);
            border-left: 4px solid var(--accent-it);
            padding: 20px;
            border-radius: 8px;
        }

        .disclaimer-card h4 {
            color: var(--accent-it);
            font-size: 0.8rem;
            text-transform: uppercase;
            margin-bottom: 8px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .disclaimer-card h4 svg {
            width: 14px;
            height: 14px;
        }

        .disclaimer-content {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .disclaimer-content ul {
            padding-left: 20px;
            margin: 0;
        }

        .disclaimer-content li {
            margin-bottom: 6px;
        }

        .disclaimer-content li:last-child {
            margin-bottom: 0;
        }

        /* Modals */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
        }

        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .modal-header svg {
            width: 24px;
            height: 24px;
            color: var(--accent-warning);
        }

        .modal-header h3 {
            font-size: 1.125rem;
            color: var(--text-primary);
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-body p {
            font-size: 0.9375rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .modal-note {
            font-size: 0.8125rem;
            color: var(--text-muted);
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-actions .btn {
            padding: 10px 20px;
        }

        .btn-danger {
            background: var(--accent-error);
            border-color: var(--accent-error);
            color: white;
        }

        .btn-danger:hover {
            opacity: 0.9;
        }

        /* Filename Input Group */
        .filename-input-group {
            display: flex;
            align-items: center;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }

        .filename-input-group input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 10px 12px;
        }

        .filename-input-group input:focus {
            box-shadow: none;
        }

        .filename-ext {
            padding: 10px 12px;
            background: var(--bg-card);
            color: var(--text-muted);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.875rem;
            border-left: 1px solid var(--border-color);
        }

        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 1001;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 0.875rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .toast.success {
            border-color: var(--accent-success);
        }

        .toast.error {
            border-color: var(--accent-error);
        }

        .toast.warning {
            border-color: var(--accent-warning);
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsive */
        @media (max-width: 1024px) {
            .calculator-layout {
                grid-template-columns: 1fr;
            }

            .workspace {
                flex-direction: column;
            }

            .editor-pane, .preview-pane {
                flex: 1 !important;
                min-height: 300px;
            }

            .split-resizer {
                display: none;
            }

            .toolbar {
                flex-wrap: wrap;
            }

            .toolbar-group {
                flex-wrap: wrap;
            }
        }

        @media (max-width: 768px) {
            .tool-btn span.btn-text {
                display: none;
            }

            .find-replace-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .find-replace-bar input {
                min-width: 100%;
            }
        }

        /* Split View Resizer */
        .split-resizer {
            width: 12px;
            cursor: col-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            flex-shrink: 0;
        }

        .split-resizer::before {
            content: '';
            width: 4px;
            height: 40px;
            background: var(--border-color);
            border-radius: 2px;
            transition: background 0.2s, height 0.2s;
        }

        .split-resizer:hover::before,
        .split-resizer.dragging::before {
            background: var(--accent-it);
            height: 60px;
        }

        .workspace.resizing {
            cursor: col-resize;
            user-select: none;
        }

        .workspace.resizing .editor-pane,
        .workspace.resizing .preview-pane {
            pointer-events: none;
        }

        /* Find/Replace Bar */
        .find-replace-bar {
            display: none;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 12px 16px;
            margin-bottom: 12px;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .find-replace-bar.active {
            display: flex;
        }

        .find-replace-bar input {
            flex: 1;
            min-width: 120px;
            padding: 8px 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.8125rem;
        }

        .find-replace-bar input:focus {
            outline: none;
            border-color: var(--accent-it);
        }

        .find-replace-bar .find-info {
            font-family: 'JetBrains Mono', monospace;
            font-size: 0.75rem;
            color: var(--text-muted);
            min-width: 70px;
            text-align: center;
        }

        .find-replace-bar .find-actions {
            display: flex;
            gap: 6px;
        }

        .find-replace-bar .find-btn {
            padding: 6px 10px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.15s;
            font-family: 'JetBrains Mono', monospace;
        }

        .find-replace-bar .find-btn:hover:not(:disabled) {
            border-color: var(--accent-it);
            color: var(--text-primary);
        }

        .find-replace-bar .find-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .find-replace-bar .find-btn.primary {
            background: var(--accent-it);
            border-color: var(--accent-it);
            color: var(--bg-primary);
        }

        .find-replace-bar .find-btn.primary:hover:not(:disabled) {
            opacity: 0.9;
        }

        .find-replace-bar .close-find {
            padding: 6px;
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .find-replace-bar .close-find:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .find-replace-bar .close-find svg {
            width: 16px;
            height: 16px;
        }

        /* Highlight matches in editor - using a pseudo overlay */
        .editor-wrapper {
            position: relative;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Virtual Scrolling */
        .preview-section {
            content-visibility: auto;
            contain-intrinsic-size: auto 200px;
        }

        /* Dropdown keyboard navigation */
        .dropdown-item.focused {
            background: var(--accent-it-dim);
            outline: 2px solid var(--accent-it);
            outline-offset: -2px;
        }

        .dropdown-item:focus {
            background: var(--accent-it-dim);
            outline: 2px solid var(--accent-it);
            outline-offset: -2px;
        }

        /* Sync scroll indicator */
        .sync-scroll-indicator {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            padding: 4px;
            border-radius: 4px;
            background: var(--bg-card);
            opacity: 0;
            transition: opacity 0.2s;
            pointer-events: none;
        }

        .sync-scroll-indicator.visible {
            opacity: 1;
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {
            .toast {
                animation: none;
            }
            
            .split-resizer::before,
            .sync-scroll-indicator {
                transition: none;
            }
        }

        /* Print Styles */
        @media print {
            body::before {
                display: none;
            }

            header, footer, .sidebar, .toolbar, .pane-header, .editor-pane, .find-replace-bar, .split-resizer {
                display: none !important;
            }

            .calculator-layout {
                display: block;
            }

            .calculator-panel {
                border: none;
                padding: 0;
            }

            .workspace {
                display: block;
            }

            .preview-pane {
                border: none;
            }

            .preview-container {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div class="header-left">
                    <a href="../tools.html" class="back-link">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="19" y1="12" x2="5" y2="12"/>
                            <polyline points="12 19 5 12 12 5"/>
                        </svg>
                        Back to Tools
                    </a>
                </div>
                <div class="header-right">
                    <div class="theme-toggle">
                        <button data-theme-toggle="light" title="Light mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="5"/>
                                <path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
                            </svg>
                        </button>
                        <button data-theme-toggle="dark" title="Dark mode">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
            <div style="margin-top: 24px; display: flex; align-items: center; gap: 16px;">
                <div class="tool-icon-header it">
                    <svg viewBox="0 0 24 24" width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <path d="M12 18v-6"/>
                        <path d="M9 15l3 3 3-3"/>
                    </svg>
                </div>
                <div>
                    <h1>Markdown Preview</h1>
                    <p class="tagline">// Markdown 1.0 • CommonMark • GFM</p>
                </div>
            </div>
        </header>

        <main>
            <div class="calculator-layout">
                <div class="calculator-panel">
                    <div class="info-banner">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <line x1="12" y1="16" x2="12" y2="12"/>
                            <line x1="12" y1="8" x2="12.01" y2="8"/>
                        </svg>
                        <span><strong>Tip:</strong> Write or paste Markdown on the left to see rendered preview on the right.
    Load sample:
    <button onclick="loadSampleContent('commonmark')" style="background: none; border: none; color: var(--accent-it); cursor: pointer; text-decoration: underline; font-size: inherit; font-family: inherit;">CommonMark</button>
    ·
    <button onclick="loadSampleContent('gfm')" style="background: none; border: none; color: var(--accent-it); cursor: pointer; text-decoration: underline; font-size: inherit; font-family: inherit;">GFM</button>
    ·
    <button onclick="loadSampleContent('original')" style="background: none; border: none; color: var(--accent-it); cursor: pointer; text-decoration: underline; font-size: inherit; font-family: inherit;">MD 1.0</button>
</span>

                    </div>

                    <div id="warningBanner" class="warning-banner hidden">
                        <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                            <line x1="12" y1="9" x2="12" y2="13"/>
                            <line x1="12" y1="17" x2="12.01" y2="17"/>
                        </svg>
                        <span id="warningText"></span>
                    </div>

                    <!-- Find/Replace Bar -->
                    <div id="findReplaceBar" class="find-replace-bar" role="search" aria-label="Find and replace">
                        <input type="text" id="findInput" placeholder="Find..." aria-label="Search text">
                        <input type="text" id="replaceInput" placeholder="Replace..." aria-label="Replacement text">
                        <span class="find-info" id="findInfo">0 / 0</span>
                        <div class="find-actions">
                            <button class="find-btn" id="findPrevBtn" title="Previous (Shift+Enter)">↑ Prev</button>
                            <button class="find-btn" id="findNextBtn" title="Next (Enter)">↓ Next</button>
                            <button class="find-btn" id="replaceBtn" title="Replace current">Replace</button>
                            <button class="find-btn primary" id="replaceAllBtn" title="Replace all">All</button>
                        </div>
                        <button class="close-find" id="closeFindBtn" title="Close (Escape)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>

                    <!-- Toolbar -->
                    <div class="toolbar">
                        <div class="toolbar-group">
                            <button class="tool-btn" onclick="copyMarkdown()" title="Copy Markdown (Ctrl+Shift+C)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                                <span class="btn-text">Copy MD</span>
                            </button>
                            <button class="tool-btn" onclick="copyHtml()" title="Copy HTML">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                                <span class="btn-text">Copy HTML</span>
                            </button>
                        </div>

                        <div class="tool-sep"></div>

                        <div class="toolbar-group">
                            <button class="tool-btn" onclick="showDownloadModal('md')" title="Download .md">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                                <span class="btn-text">.md</span>
                            </button>
                            <button class="tool-btn" onclick="showDownloadModal('html')" title="Download .html">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                <span class="btn-text">.html</span>
                            </button>
                            <button class="tool-btn" onclick="printPreview()" title="Print (Ctrl+P)">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
                                <span class="btn-text">Print</span>
                            </button>
                        </div>

                        <div class="tool-sep"></div>

                        <div class="toolbar-group">
                            <button class="tool-btn danger" onclick="showClearModal()" title="Clear">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                <span class="btn-text">Clear</span>
                            </button>
                        </div>

                        <div class="tool-sep"></div>

                        <!-- Mode Toggle -->
                        <div class="mode-toggle">
                            <button id="modeOriginal" onclick="setMode('original')" title="Markdown 1.0 (Gruber)">MD 1.0</button>
                            <button id="modeCommonmark" class="active" onclick="setMode('commonmark')" title="CommonMark 0.31">CommonMark</button>
                            <button id="modeGfm" onclick="setMode('gfm')" title="GitHub Flavored Markdown 0.29">GFM</button>
                        </div>

                        <div class="tool-sep"></div>

                        <!-- Live Preview Toggle -->
                        <label class="toggle-switch">
                            <input type="checkbox" id="livePreviewToggle" checked onchange="toggleLivePreview()">
                            <span id="livePreviewLabel">Live Preview</span>
                        </label>

                        <button class="tool-btn" id="updatePreviewBtn" onclick="renderPreview()" style="display: none;" title="Update Preview">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                            <span class="btn-text">Update</span>
                        </button>

                        <div class="tool-sep"></div>

                        <!-- Insert Dropdown -->
                        <div class="dropdown">
                            <button class="tool-btn" onclick="toggleInsertDropdown()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                <span class="btn-text">Insert</span>
                                <svg viewBox="0 0 24 24" width="12" height="12" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                            </button>
                            <div id="insertDropdown" class="dropdown-menu" tabindex="-1" role="menu">
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('bold')">Bold <code>**text**</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('italic')">Italic <code>*text*</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('code')">Code <code>`code`</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('codeblock')">Code Block <code>```</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('link')">Link <code>[](url)</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('image')">Image <code>![](url)</code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('heading')">Heading <code>## </code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('quote')">Quote <code>> </code></div>
                                <div class="dropdown-item" role="menuitem" tabindex="-1" onclick="insertFormatting('task')">Task List <code>- [ ]</code></div>
                            </div>
                        </div>

                        <!-- Experimental Mode (right side) -->
                        <label class="toggle-switch" style="margin-left: auto;" title="Bypass performance limits for large documents">
                            <input type="checkbox" id="experimentalToggle" onchange="toggleExperimental()">
                            <span style="font-size: 0.6875rem;">Experimental</span>
                        </label>
                    </div>

                    <!-- Workspace -->
                    <div class="workspace">
                        <div class="editor-pane">
                            <div class="pane-header">
                                <div class="pane-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                                    Editor
                                </div>
                            </div>
                            <textarea id="editor" placeholder="Type or paste Markdown here..." spellcheck="false" aria-label="Markdown editor"></textarea>
                        </div>
                        
                        <!-- Split Resizer -->
                        <div class="split-resizer" id="splitResizer" role="separator" aria-label="Resize panels" tabindex="0"></div>
                        
                        <div class="preview-pane">
                            <div class="pane-header">
                                <div class="pane-title">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                    Preview
                                </div>
                                <span id="renderTimeDisplay" style="font-size: 0.6875rem; color: var(--text-muted);"></span>
                            </div>
                            <div id="preview" class="preview-container" role="region" aria-label="Rendered preview" aria-live="polite">
                                <div class="preview-placeholder">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                                        <polyline points="14 2 14 8 20 8"/>
                                    </svg>
                                    <p>Your rendered Markdown will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar -->
                <aside class="sidebar">
                    <!-- Stats Card -->
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg>
                            Document Stats
                        </h3>
                        <div class="stat-row">
                            <span class="stat-label">Characters</span>
                            <span class="stat-val" id="statChars">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Words</span>
                            <span class="stat-val" id="statWords">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Lines</span>
                            <span class="stat-val" id="statLines">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Mode</span>
                            <span class="stat-val" id="statMode">CommonMark</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Render Time</span>
                            <span class="stat-val" id="statRender">0ms</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Live Preview</span>
                            <span class="stat-val" id="statLive">ON</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Reading Time</span>
                            <span class="stat-val" id="statReadTime">0 min</span>
                        </div>
                    </div>

                    <!-- Images Card -->
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                            Images
                        </h3>
                        <div class="image-upload-zone" id="dropZone" onclick="document.getElementById('imageInput').click()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <p>Click or drag images here</p>
                            <p style="font-size: 0.625rem; margin-top: 4px;">PNG, JPG, GIF, WebP (max 10MB each)</p>
                        </div>
                        <input type="file" id="imageInput" accept="image/png,image/jpeg,image/gif,image/webp" multiple style="display: none;" onchange="handleImageUpload(this.files)">
                        <div id="imageList" class="image-list"></div>
                        <div class="storage-info" id="storageInfo">Session storage: 0 KB / 50 MB</div>
                    </div>

                    <!-- Status Card -->
                    <div class="sidebar-card">
                        <h3>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
                            Autosave Status
                        </h3>
                        <div class="status-indicator">
                            <div class="status-dot" id="statusDot"></div>
                            <span class="status-text" id="statusText">Saved</span>
                        </div>
                        <div class="status-time" id="statusTime">Last: Just now</div>
                        <button class="status-btn" onclick="clearDraft()">Clear Saved Draft</button>
                    </div>

                    <!-- Disclaimer Card -->
                    <div class="disclaimer-card">
                        <h4>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                            Usage Notes
                        </h4>
                        <div class="disclaimer-content">
                            <ul>
                                <li><strong>MD 1.0:</strong> Original Markdown (Gruber) — pedantic mode matching markdown.pl behavior.</li>
                                <li><strong>CommonMark:</strong> Strict, unambiguous spec (0.31) — recommended for portability.</li>
                                <li><strong>GFM:</strong> GitHub Flavored Markdown (0.29) — adds tables, task lists, strikethrough.</li>
                                <li><strong>Session Images:</strong> Uploaded images are session-only; lost on refresh.</li>
                                <li><strong>No Warranty:</strong> This tool is provided as-is for convenience.</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Open Source Licenses -->
                    <div class="disclaimer-card" style="border-left-color: var(--text-muted); margin-top: 16px;">
                        <h4 style="color: var(--text-secondary);">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>
                            Open Source Licenses
                        </h4>
                        <div class="disclaimer-content">
                            <ul>
                                <li><strong><a href="https://github.com/markedjs/marked" target="_blank" rel="noopener" style="color: var(--accent-it);">marked</a></strong> — MIT License<br><span style="font-size: 0.7rem;">© 2018+ MarkedJS, © 2011-2018 Christopher Jeffrey</span></li>
                                <li><strong><a href="https://github.com/cure53/DOMPurify" target="_blank" rel="noopener" style="color: var(--accent-it);">DOMPurify</a></strong> — Apache 2.0 / MPL 2.0<br><span style="font-size: 0.7rem;">© Dr.-Ing. Mario Heiderich, Cure53</span></li>
                                <li><strong><a href="https://github.com/PrismJS/prism">Prism</a></strong> — MIT License<br><span>© Lea Verou</span></li>
                            </ul>
                        </div>
                    </div>
                </aside>

            </div>

        </main>

        <footer>
            <div class="footer-content">
                <p class="footer-text">© 2025 Tools Hub — Built for engineers</p>
                <nav class="footer-links">
                    <a href="../tools.html">All Tools</a>
                    <a href="#">Report Issue</a>
                </nav>
            </div>

        </footer>
    </div>

    <!-- Clear Confirmation Modal -->
    <div class="modal-overlay" id="clearModal">
        <div class="modal-card">
            <div class="modal-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
                <h3>Clear Document?</h3>
            </div>
            <div class="modal-body">
                <p>This will delete <strong id="clearCharCount">0 characters</strong> of content.</p>
                <p class="modal-note">This action cannot be undone.</p>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('clearModal')">Cancel</button>
                <button class="btn btn-danger" onclick="confirmClear()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Download Modal -->
    <div class="modal-overlay" id="downloadModal">
        <div class="modal-card">
            <div class="modal-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                    <polyline points="7 10 12 15 17 10"/>
                    <line x1="12" y1="15" x2="12" y2="3"/>
                </svg>
                <h3>Download File</h3>
            </div>
            <div class="modal-body">
                <label for="filenameInput">Filename</label>
                <div class="filename-input-group">
                    <input type="text" id="filenameInput" value="markdown">
                    <span class="filename-ext" id="filenameExt">.md</span>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeModal('downloadModal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmDownload()">Download</button>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer" role="status" aria-live="polite" aria-atomic="true"></div>

    <!-- Vendor Libraries -->
    <script type="module">
        import * as MarkedNS from "../js/vendor/markdown_preview/marked.esm.min.js";

        window.marked = MarkedNS.marked ?? MarkedNS.default;

        //quick sanity log
        console.log("Marked loaded:", typeof window.marked, window.marked);
    </script>
    <script src="../js/vendor/markdown_preview/purify.min.js"></script>
    <!-- Prism.js syntax highlighting (self-hosted) -->
    <script src="../js/vendor/markdown_preview/prism.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-python.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-javascript.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-css.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-bash.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-json.min.js"></script>
    <script src="../js/vendor/markdown_preview/prism-markdown.min.js"></script>
    <script>
        // Debug: verify Prism loaded
        if (typeof Prism !== 'undefined') {
            console.log('Prism loaded successfully. Languages:', Object.keys(Prism.languages));
        } else {
            console.error('Prism failed to load!');
        }
    </script>
    
    <script src="../js/shared.js"></script>

    <script>
        // ============================================
        // STATE & CONFIGURATION
        // ============================================

        const STORAGE_KEYS = {
            DRAFT: 'mdpreview_draft',
            MODE: 'mdpreview_mode',
            LIVE_PREVIEW: 'mdpreview_livepreview',
            EXPERIMENTAL: 'mdpreview_experimental',
            MISSING_IMAGES: 'mdpreview_missing_images',
            SPLIT_RATIO: 'mdpreview_split_ratio'
        };

        // Consolidated mode labels
        const MODE_LABELS = {
            original: 'MD 1.0',
            commonmark: 'CommonMark',
            gfm: 'GFM'
        };

        // Magic numbers extracted to named constants
        const MAX_DRAFT_BYTES = 1000000;        // 1 MB
        const MAX_DRAFT_CHARS = 300000;         // 300k chars
        const AUTOSAVE_DEBOUNCE = 1000;         // 1 second
        const RENDER_DEBOUNCE = 100;            // 100ms
        const SLOW_THRESHOLD_MS = 100;
        const RENDER_HISTORY_SIZE = 5;
        const LARGE_DOC_THRESHOLD = 200000;     // 200k chars
        const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10 MB
        const MAX_SESSION_STORAGE = 50 * 1024 * 1024; // 50 MB
        const TOAST_DURATION = 3000;            // 3 seconds
        const TOAST_FADE_DURATION = 300;        // 300ms fade out
        const CLEAR_MODAL_THRESHOLD = 500;      // Show modal if > 500 chars
        const WORDS_PER_MINUTE = 200;           // Average reading speed
        const VIRTUAL_SCROLL_THRESHOLD = 100000; // Enable virtual scroll above this
        const SCROLL_SYNC_DEBOUNCE = 16;        // ~60fps
        const MIN_PANE_WIDTH = 200;             // Minimum width for editor/preview
        const VALID_FILENAME_REGEX = /^[a-zA-Z0-9_\-. ]+$/;

        // State
        let currentMode = 'commonmark';
        let livePreviewEnabled = true;
        let experimentalMode = false;
        let renderTimes = [];
        let hasUnsavedChanges = false;
        let lastSavedContent = '';
        let lastSaveTime = null;
        let uploadedImages = new Map();
        let pendingDownloadType = null;

        // DOM Elements
        const editor = document.getElementById('editor');
        const preview = document.getElementById('preview');
        const statChars = document.getElementById('statChars');
        const statWords = document.getElementById('statWords');
        const statLines = document.getElementById('statLines');
        const statMode = document.getElementById('statMode');
        const statRender = document.getElementById('statRender');
        const statLive = document.getElementById('statLive');
        const renderTimeDisplay = document.getElementById('renderTimeDisplay');
        const warningBanner = document.getElementById('warningBanner');
        const warningText = document.getElementById('warningText');
        const livePreviewToggle = document.getElementById('livePreviewToggle');
        const livePreviewLabel = document.getElementById('livePreviewLabel');
        const experimentalToggle = document.getElementById('experimentalToggle');
        const updatePreviewBtn = document.getElementById('updatePreviewBtn');
        const insertDropdown = document.getElementById('insertDropdown');
        const dropZone = document.getElementById('dropZone');
        const imageList = document.getElementById('imageList');
        const storageInfo = document.getElementById('storageInfo');
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        const statusTime = document.getElementById('statusTime');

        const statReadTime = document.getElementById('statReadTime');

        // Debounce timers
        let renderTimer = null;
        let autosaveTimer = null;

        // Undo/Redo State
        const undoStack = [];
        const redoStack = [];
        const MAX_UNDO_STACK = 50;
        let lastSnapshot = '';

        // Scroll sync state
        let isEditorScrolling = false;
        let isPreviewScrolling = false;
        let scrollSyncTimer = null;

        // Split resizer state
        let isResizing = false;
        let splitRatio = 0.5;

        // Find/Replace state
        let findMatches = [];
        let currentMatchIndex = -1;

        // Lazy-loaded Prism languages
        const loadedPrismLanguages = new Set(['plaintext']);
        const PRISM_LANGUAGE_MAP = {
            'js': 'javascript',
            'ts': 'typescript',
            'py': 'python',
            'rb': 'ruby',
            'sh': 'bash',
            'shell': 'bash',
            'yml': 'yaml',
            'md': 'markdown'
        };

        // Memoization cache for embedded styles
        const embeddedStylesCache = new Map();

        // ============================================
        // UNDO/REDO SYSTEM
        // ============================================

        function saveSnapshot() {
            const currentContent = editor.value;
            if (currentContent !== lastSnapshot) {
                undoStack.push(lastSnapshot);
                if (undoStack.length > MAX_UNDO_STACK) {
                    undoStack.shift();
                }
                redoStack.length = 0; // Clear redo stack on new change
                lastSnapshot = currentContent;
            }
        }

        function undo() {
            if (undoStack.length === 0) return;
            
            redoStack.push(editor.value);
            const previousState = undoStack.pop();
            editor.value = previousState;
            lastSnapshot = previousState;
            
            updateStats();
            renderPreview();
            showToast('Undo', 'success');
            editor.focus();
        }

        function redo() {
            if (redoStack.length === 0) return;
            
            undoStack.push(editor.value);
            const nextState = redoStack.pop();
            editor.value = nextState;
            lastSnapshot = nextState;
            
            updateStats();
            renderPreview();
            showToast('Redo', 'success');
            editor.focus(); 
        }
        // ============================================
        // SANITIZATION CONFIG
        // ============================================

        const sanitizerConfig = {
            ALLOWED_TAGS: [
                'p', 'br', 'hr',
                'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
                'em', 'strong', 'del', 's',
                'ul', 'ol', 'li',
                'blockquote',
                'pre', 'code',
                'table', 'thead', 'tbody', 'tr', 'th', 'td',
                'a', 'img',
                'span', 'div',
                'input'
            ],
            ALLOWED_ATTR: [
                'href', 'src', 'alt', 'title',
                'class', 'id',
                'align', 'colspan', 'rowspan',
                'type', 'checked', 'disabled'
            ],
            ALLOW_DATA_ATTR: false,
            ALLOWED_URI_REGEXP: /^(?:(?:https?|blob):)/i
        };

        // ============================================
        // INITIALIZATION
        // ============================================

        document.addEventListener('DOMContentLoaded', () => {
            restoreSettings();
            restoreDraft();
            setupEventListeners();
            updateStats();
        });

        function restoreSettings() {
            // Restore mode
            const savedMode = localStorage.getItem(STORAGE_KEYS.MODE);
            if (savedMode) {
                setMode(savedMode, false);
            }

            // Restore live preview
            const savedLivePreview = localStorage.getItem(STORAGE_KEYS.LIVE_PREVIEW);
            if (savedLivePreview !== null) {
                livePreviewEnabled = savedLivePreview === 'true';
                livePreviewToggle.checked = livePreviewEnabled;
                updateLivePreviewUI();
            }

            // Restore experimental mode
            const savedExperimental = localStorage.getItem(STORAGE_KEYS.EXPERIMENTAL);
            if (savedExperimental !== null) {
                experimentalMode = savedExperimental === 'true';
                experimentalToggle.checked = experimentalMode;
            }
        }

        function restoreDraft() {
            try {
                const draft = localStorage.getItem(STORAGE_KEYS.DRAFT);
                
                // Validate the draft data
                if (draft && typeof draft === 'string') {
                    // Check for reasonable size
                    if (draft.length > MAX_DRAFT_CHARS * 1.5) {
                        console.warn('Draft exceeds maximum size, clearing corrupted data');
                        localStorage.removeItem(STORAGE_KEYS.DRAFT);
                        return;
                    }
                    
                    editor.value = draft;
                    lastSavedContent = draft;
                    updateStats();
                    renderPreview();

                    // Check for missing local images with validation
                    try {
                        const missingImagesRaw = localStorage.getItem(STORAGE_KEYS.MISSING_IMAGES);
                        if (missingImagesRaw) {
                            const missingImages = JSON.parse(missingImagesRaw);
                            if (Array.isArray(missingImages) && missingImages.length > 0) {
                                // Validate each entry is a string
                                const validImages = missingImages.filter(img => typeof img === 'string');
                                if (validImages.length > 0) {
                                    showWarning(`Missing images from previous session: ${validImages.join(', ')}. Re-upload to restore.`);
                                }
                            }
                        }
                    } catch (jsonErr) {
                        console.warn('Invalid missing images data, clearing:', jsonErr);
                        localStorage.removeItem(STORAGE_KEYS.MISSING_IMAGES);
                    }
                }
            } catch (err) {
                console.error('Error restoring draft:', err);
                showToast('Could not restore saved draft', 'warning');
            }
        }

        function setupEventListeners() {
            // Editor input
            editor.addEventListener('input', onEditorInput);

            // Save snapshot before user types (for undo)
            editor.addEventListener('beforeinput', saveSnapshot);

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Dropdown close on outside click and keyboard navigation
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.dropdown')) {
                    insertDropdown.classList.remove('active');
                    resetDropdownFocus();
                }
            });

            // Dropdown keyboard navigation
            insertDropdown.addEventListener('keydown', handleDropdownKeyboard);

            // Image drag and drop
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('drag-over');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('drag-over');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('drag-over');
                handleImageUpload(e.dataTransfer.files);
            });

            // Beforeunload warning
            window.addEventListener('beforeunload', (e) => {
                if (hasUnsavedChanges) {
                    e.preventDefault();
                    e.returnValue = '';
                }
            });

            // Modal escape key
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('findReplaceBar').classList.contains('active')) {
                        closeFindReplace();
                    } else {
                        closeAllModals();
                    }
                }
            });

            // Scroll sync
            setupScrollSync();

            // Split resizer
            setupSplitResizer();

            // Find/Replace
            setupFindReplace();
        }

        // ============================================
        // SCROLL SYNC
        // ============================================

        function setupScrollSync() {
            const editorPane = editor;
            const previewPane = preview;

            editorPane.addEventListener('scroll', () => {
                if (isPreviewScrolling) return;
                
                isEditorScrolling = true;
                clearTimeout(scrollSyncTimer);
                
                const scrollRatio = editorPane.scrollTop / (editorPane.scrollHeight - editorPane.clientHeight || 1);
                const targetScroll = scrollRatio * (previewPane.scrollHeight - previewPane.clientHeight);
                
                previewPane.scrollTop = targetScroll;
                
                scrollSyncTimer = setTimeout(() => {
                    isEditorScrolling = false;
                }, SCROLL_SYNC_DEBOUNCE);
            });

            previewPane.addEventListener('scroll', () => {
                if (isEditorScrolling) return;
                
                isPreviewScrolling = true;
                clearTimeout(scrollSyncTimer);
                
                const scrollRatio = previewPane.scrollTop / (previewPane.scrollHeight - previewPane.clientHeight || 1);
                const targetScroll = scrollRatio * (editorPane.scrollHeight - editorPane.clientHeight);
                
                editorPane.scrollTop = targetScroll;
                
                scrollSyncTimer = setTimeout(() => {
                    isPreviewScrolling = false;
                }, SCROLL_SYNC_DEBOUNCE);
            });
        }

        // ============================================
        // SPLIT RESIZER
        // ============================================

        function setupSplitResizer() {
            const resizer = document.getElementById('splitResizer');
            const workspace = document.querySelector('.workspace');
            const editorPane = document.querySelector('.editor-pane');
            const previewPane = document.querySelector('.preview-pane');

            if (!resizer || !workspace) return;

            // Restore saved ratio
            const savedRatio = localStorage.getItem(STORAGE_KEYS.SPLIT_RATIO);
            if (savedRatio) {
                splitRatio = parseFloat(savedRatio);
                if (isNaN(splitRatio) || splitRatio < 0.2 || splitRatio > 0.8) {
                    splitRatio = 0.5;
                }
                applySplitRatio();
            }

            resizer.addEventListener('mousedown', startResize);
            resizer.addEventListener('touchstart', startResize, { passive: false });

            // Keyboard support for resizer
            resizer.addEventListener('keydown', (e) => {
                const step = e.shiftKey ? 0.1 : 0.02;
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    splitRatio = Math.max(0.2, splitRatio - step);
                    applySplitRatio();
                    saveSplitRatio();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    splitRatio = Math.min(0.8, splitRatio + step);
                    applySplitRatio();
                    saveSplitRatio();
                }
            });

            function startResize(e) {
                e.preventDefault();
                isResizing = true;
                resizer.classList.add('dragging');
                workspace.classList.add('resizing');
                
                document.addEventListener('mousemove', doResize);
                document.addEventListener('mouseup', stopResize);
                document.addEventListener('touchmove', doResize, { passive: false });
                document.addEventListener('touchend', stopResize);
            }

            function doResize(e) {
                if (!isResizing) return;
                
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                const workspaceRect = workspace.getBoundingClientRect();
                const newRatio = (clientX - workspaceRect.left) / workspaceRect.width;
                
                // Clamp between 20% and 80%
                splitRatio = Math.max(0.2, Math.min(0.8, newRatio));
                applySplitRatio();
            }

            function stopResize() {
                isResizing = false;
                resizer.classList.remove('dragging');
                workspace.classList.remove('resizing');
                
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
                document.removeEventListener('touchmove', doResize);
                document.removeEventListener('touchend', stopResize);
                
                saveSplitRatio();
            }

            function applySplitRatio() {
                const gapWidth = 16 + 12; // gap + resizer width
                editorPane.style.flex = `0 0 calc(${splitRatio * 100}% - ${gapWidth / 2}px)`;
                previewPane.style.flex = `0 0 calc(${(1 - splitRatio) * 100}% - ${gapWidth / 2}px)`;
            }

            function saveSplitRatio() {
                localStorage.setItem(STORAGE_KEYS.SPLIT_RATIO, splitRatio.toString());
            }
        }

        // ============================================
        // FIND/REPLACE
        // ============================================

        function setupFindReplace() {
            const findInput = document.getElementById('findInput');
            const replaceInput = document.getElementById('replaceInput');
            const findPrevBtn = document.getElementById('findPrevBtn');
            const findNextBtn = document.getElementById('findNextBtn');
            const replaceBtn = document.getElementById('replaceBtn');
            const replaceAllBtn = document.getElementById('replaceAllBtn');
            const closeFindBtn = document.getElementById('closeFindBtn');

            findInput.addEventListener('input', debounce(performFind, 150));
            findInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    if (e.shiftKey) {
                        findPrevious();
                    } else {
                        findNext();
                    }
                }
            });

            replaceInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    replaceCurrent();
                }
            });

            findPrevBtn.addEventListener('click', findPrevious);
            findNextBtn.addEventListener('click', findNext);
            replaceBtn.addEventListener('click', replaceCurrent);
            replaceAllBtn.addEventListener('click', replaceAll);
            closeFindBtn.addEventListener('click', closeFindReplace);
        }

        function openFindReplace() {
            const findBar = document.getElementById('findReplaceBar');
            findBar.classList.add('active');
            
            const findInput = document.getElementById('findInput');
            
            // Pre-fill with selection if any
            const selectedText = editor.value.substring(editor.selectionStart, editor.selectionEnd);
            if (selectedText && selectedText.length < 100 && !selectedText.includes('\n')) {
                findInput.value = selectedText;
            }
            
            findInput.focus();
            findInput.select();
            
            if (findInput.value) {
                performFind();
            }
        }

        function closeFindReplace() {
            document.getElementById('findReplaceBar').classList.remove('active');
            findMatches = [];
            currentMatchIndex = -1;
            updateFindInfo();
            editor.focus();
        }

        function performFind() {
            const searchText = document.getElementById('findInput').value;
            findMatches = [];
            currentMatchIndex = -1;

            if (!searchText) {
                updateFindInfo();
                return;
            }

            const content = editor.value;
            const searchLower = searchText.toLowerCase();
            const contentLower = content.toLowerCase();
            
            let pos = 0;
            while ((pos = contentLower.indexOf(searchLower, pos)) !== -1) {
                findMatches.push({
                    start: pos,
                    end: pos + searchText.length
                });
                pos += 1;
            }

            if (findMatches.length > 0) {
                // Find closest match to cursor
                const cursorPos = editor.selectionStart;
                currentMatchIndex = findMatches.findIndex(m => m.start >= cursorPos);
                if (currentMatchIndex === -1) currentMatchIndex = 0;
                
                // Don't highlight yet - wait for user to press Enter or click a button
                // This prevents stealing focus from the input field
            }

            updateFindInfo();
        }

        function findNext() {
            if (findMatches.length === 0) {
                // Try to find first if user just typed and hit enter
                performFind();
                if (findMatches.length === 0) return;
            }
            
            currentMatchIndex = (currentMatchIndex + 1) % findMatches.length;
            highlightCurrentMatch();
            updateFindInfo();
        }

        function findPrevious() {
            if (findMatches.length === 0) {
                performFind();
                if (findMatches.length === 0) return;
            }
            
            currentMatchIndex = (currentMatchIndex - 1 + findMatches.length) % findMatches.length;
            highlightCurrentMatch();
            updateFindInfo();
        }

        function highlightCurrentMatch() {
            if (currentMatchIndex < 0 || currentMatchIndex >= findMatches.length) return;
            
            const match = findMatches[currentMatchIndex];
            editor.focus();
            editor.setSelectionRange(match.start, match.end);
            
            // Scroll into view
            const lineHeight = parseInt(getComputedStyle(editor).lineHeight) || 24;
            const linesAbove = editor.value.substring(0, match.start).split('\n').length - 1;
            const scrollTarget = linesAbove * lineHeight - editor.clientHeight / 2;
            editor.scrollTop = Math.max(0, scrollTarget);
        }

        function replaceCurrent() {
            if (findMatches.length === 0 || currentMatchIndex < 0) return;
            
            const replaceText = document.getElementById('replaceInput').value;
            const match = findMatches[currentMatchIndex];
            
            saveSnapshot();
            
            const before = editor.value.substring(0, match.start);
            const after = editor.value.substring(match.end);
            editor.value = before + replaceText + after;
            
            // Trigger updates
            onEditorInput({ inputType: 'insertText', data: '' });
            
            // Re-find and move to next
            performFind();
            showToast('Replaced 1 occurrence', 'success');
        }

        function replaceAll() {
            const searchText = document.getElementById('findInput').value;
            const replaceText = document.getElementById('replaceInput').value;
            
            if (!searchText || findMatches.length === 0) {
                showToast('Nothing to replace', 'warning');
                return;
            }
            
            saveSnapshot();
            
            const count = findMatches.length;
            
            // Replace all occurrences (case-insensitive)
            const regex = new RegExp(escapeRegex(searchText), 'gi');
            editor.value = editor.value.replace(regex, replaceText);
            
            // Trigger updates
            onEditorInput({ inputType: 'insertText', data: '' });
            
            // Clear matches
            findMatches = [];
            currentMatchIndex = -1;
            updateFindInfo();
            
            showToast(`Replaced ${count} occurrence${count !== 1 ? 's' : ''}`, 'success');
        }

        function updateFindInfo() {
            const info = document.getElementById('findInfo');
            if (findMatches.length === 0) {
                info.textContent = '0 / 0';
            } else {
                info.textContent = `${currentMatchIndex + 1} / ${findMatches.length}`;
            }
            
            // Update button states
            const hasMatches = findMatches.length > 0;
            document.getElementById('findPrevBtn').disabled = !hasMatches;
            document.getElementById('findNextBtn').disabled = !hasMatches;
            document.getElementById('replaceBtn').disabled = !hasMatches;
            document.getElementById('replaceAllBtn').disabled = !hasMatches;
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ============================================
        // DROPDOWN KEYBOARD NAVIGATION
        // ============================================

        let dropdownFocusIndex = -1;

        function handleDropdownKeyboard(e) {
            const items = insertDropdown.querySelectorAll('.dropdown-item');
            if (items.length === 0) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                dropdownFocusIndex = Math.min(dropdownFocusIndex + 1, items.length - 1);
                updateDropdownFocus(items);
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                dropdownFocusIndex = Math.max(dropdownFocusIndex - 1, 0);
                updateDropdownFocus(items);
            } else if (e.key === 'Enter' && dropdownFocusIndex >= 0) {
                e.preventDefault();
                items[dropdownFocusIndex].click();
            } else if (e.key === 'Escape') {
                insertDropdown.classList.remove('active');
                resetDropdownFocus();
            }
        }

        function updateDropdownFocus(items) {
            items.forEach((item, i) => {
                item.classList.toggle('focused', i === dropdownFocusIndex);
            });
            if (dropdownFocusIndex >= 0) {
                items[dropdownFocusIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function resetDropdownFocus() {
            dropdownFocusIndex = -1;
            insertDropdown.querySelectorAll('.dropdown-item').forEach(item => {
                item.classList.remove('focused');
            });
        }

        function toggleInsertDropdown() {
            const isActive = insertDropdown.classList.toggle('active');
            if (isActive) {
                dropdownFocusIndex = -1;
                // Focus first item for keyboard nav
                setTimeout(() => insertDropdown.focus(), 0);
            }
        }

        // ============================================
        // EDITOR INPUT HANDLING
        // ============================================

        function onEditorInput(e) {
            hasUnsavedChanges = editor.value !== lastSavedContent;

            // Large document fast-path (only on typing, not paste)
            if (e.inputType && e.inputType.startsWith('insert') && e.data && e.data.length < 100) {
                if (editor.value.length > LARGE_DOC_THRESHOLD && !experimentalMode) {
                    disableLivePreview();
                    showWarning('Document exceeds 200k characters. Live preview paused. Use manual update or enable Experimental Mode.');
                }
            }

            if (livePreviewEnabled) {
                clearTimeout(renderTimer);
                renderTimer = setTimeout(renderPreview, RENDER_DEBOUNCE);
            }

            // Autosave
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(autosave, AUTOSAVE_DEBOUNCE);

            updateStats();
        }

        function handleKeyboardShortcuts(e) {
            // Tab - Insert tab character (only when editor is focused)
            if (e.key === 'Tab' && document.activeElement === editor) {
                e.preventDefault();
                
                const start = editor.selectionStart;
                const end = editor.selectionEnd;
                const text = editor.value;
                
                // Save for undo
                saveSnapshot();
                
                if (e.shiftKey) {
                    // Shift+Tab: Remove indentation from start of current line(s)
                    const beforeCursor = text.substring(0, start);
                    const lineStart = beforeCursor.lastIndexOf('\n') + 1;
                    const linePrefix = text.substring(lineStart, start);
                    
                    // Remove leading whitespace up to 4 spaces or 1 tab
                    const lineContent = text.substring(lineStart);
                    let removeCount = 0;

                    if (lineContent.startsWith('\t')) {
                        removeCount = 1;
                    } else {
                        // Count leading spaces (up to 4)
                        const leadingSpaces = lineContent.match(/^ {1,4}/);
                        if (leadingSpaces) {
                            removeCount = leadingSpaces[0].length;
                        }
                    }

                    if (removeCount > 0) {
                        editor.value = text.substring(0, lineStart) + text.substring(lineStart + removeCount);
                        editor.selectionStart = editor.selectionEnd = Math.max(lineStart, start - removeCount);
                    }
                } else {
                    // Tab: Insert 4 spaces (more portable than \t)
                    const indent = '    ';
                    editor.value = text.substring(0, start) + indent + text.substring(end);
                    editor.selectionStart = editor.selectionEnd = start + indent.length;
                }
                
                // Trigger updates
                if (livePreviewEnabled) {
                    debouncedRender();
                }
                scheduleAutosave();
                updateStats();
            }
            // Ctrl+Z - Undo (only when editor is focused)
            if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
                if (document.activeElement === editor) {
                    e.preventDefault();
                    undo();
                }
            }

            // Ctrl+Y or Ctrl+Shift+Z - Redo (only when editor is focused)
            if ((e.ctrlKey || e.metaKey) && (e.key.toLowerCase() === 'y' || (e.key.toLowerCase() === 'z' && e.shiftKey))) {
                if (document.activeElement === editor) {
                    e.preventDefault();
                    redo();
                }
            }

            // Ctrl+B - Bold (only when editor is focused)
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'b') {
                if (document.activeElement === editor) {
                    e.preventDefault();
                    insertFormatting('bold');
                }
            }

            // Ctrl+I - Italic (only when editor is focused)
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'i') {
                if (document.activeElement === editor) {
                    e.preventDefault();
                    insertFormatting('italic');
                }
            }

            // Ctrl+K - Link (only when editor is focused)
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
                if (document.activeElement === editor) {
                    e.preventDefault();
                    insertFormatting('link');
                }
            }

            // Ctrl+Shift+C - Copy Markdown
            if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'C') {
                e.preventDefault();
                copyMarkdown();
            }

            // Ctrl+P - Print
            if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
                e.preventDefault();
                printPreview();
            }

            // Ctrl+F - Find
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'f') {
                e.preventDefault();
                openFindReplace();
            }

            // Ctrl+H - Replace (only works when not in browser that uses it for history)
            if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'h') {
                e.preventDefault();
                openFindReplace();
                // Focus replace input
                setTimeout(() => document.getElementById('replaceInput').focus(), 50);
            }
        }

        function closeDropdowns() {
            insertDropdown.classList.remove('active');
            resetDropdownFocus();
        }

        // ============================================
        // MARKDOWN RENDERING
        // ============================================

        function renderPreview() {
            const start = performance.now();

            const markdown = editor.value;

            if (!markdown.trim()) {
                preview.innerHTML = `
                    <div class="preview-placeholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <polyline points="14 2 14 8 20 8"/>
                        </svg>
                        <p>Your rendered Markdown will appear here</p>
                    </div>
                `;
                updateRenderStats(0);
                return;
            }

            if (!window.marked) {
                throw new Error(
                    "Marked is not available (window.marked is undefined). " +
                    "You are likely loading the ESM build without bridging it to a global."
                );
            }

            try {
                // Configure marked based on mode
                // See: https://marked.js.org/using_advanced#options
                // Base options for all modes - langPrefix ensures Prism can detect language
                const baseOptions = {
                    langPrefix: 'language-'  // Required for Prism syntax highlighting
                };

                switch (currentMode) {
                    case 'original':
                        // Markdown 1.0 (John Gruber's original spec)
                        // pedantic mode conforms to markdown.pl as much as possible
                        // Note: Original markdown doesn't support fenced code blocks
                        marked.setOptions({
                            ...baseOptions,
                            gfm: false,
                            breaks: false,
                            pedantic: true
                        });
                        break;
                    case 'commonmark':
                        // CommonMark 0.31 - strict, unambiguous specification
                        marked.setOptions({
                            ...baseOptions,
                            gfm: false,
                            breaks: false,
                            pedantic: false
                        });
                        break;
                    case 'gfm':
                        // GitHub Flavored Markdown 0.29
                        // Extends CommonMark with tables, task lists, strikethrough, autolinks
                        marked.setOptions({
                            ...baseOptions,
                            gfm: true,
                            breaks: true,
                            pedantic: false
                        });
                        break;
                }

                // Parse markdown
                const html = marked.parse(markdown);

                // Sanitize
                const sanitized = DOMPurify.sanitize(html, sanitizerConfig);

                // Map local images
                const mapped = mapLocalImages(sanitized);

                // For large documents, use virtual scrolling with sections
                if (markdown.length > VIRTUAL_SCROLL_THRESHOLD) {
                    renderWithVirtualScrolling(mapped);
                } else {
                    // Insert into DOM normally
                    preview.innerHTML = mapped;
                }

                // Harden links and images
                hardenLinks(preview);
                hardenImages(preview);
                
                // Apply syntax highlighting with lazy loading
                applySyntaxHighlighting();

            } catch (err) {
                console.error('Markdown parsing error:', err);
                showToast('Parsing error occurred. Check your markdown syntax.', 'error');
            }

            const elapsed = performance.now() - start;
            updateRenderStats(elapsed);
            checkPerformance(elapsed);
        }

        // ============================================
        // VIRTUAL SCROLLING FOR LARGE DOCUMENTS
        // ============================================

        function renderWithVirtualScrolling(html) {
            // Parse HTML into a temporary container
            const temp = document.createElement('div');
            temp.innerHTML = html;
            
            // Split content into sections based on headers
            const sections = [];
            let currentSection = document.createElement('div');
            currentSection.className = 'preview-section';
            
            Array.from(temp.childNodes).forEach(node => {
                if (node.nodeType === Node.ELEMENT_NODE && /^H[1-3]$/.test(node.tagName)) {
                    // Start a new section on major headers
                    if (currentSection.childNodes.length > 0) {
                        sections.push(currentSection);
                        currentSection = document.createElement('div');
                        currentSection.className = 'preview-section';
                    }
                }
                currentSection.appendChild(node.cloneNode(true));
            });
            
            // Don't forget the last section
            if (currentSection.childNodes.length > 0) {
                sections.push(currentSection);
            }
            
            // Clear and add sections
            preview.innerHTML = '';
            sections.forEach(section => preview.appendChild(section));
            
            // Set up intersection observer for lazy rendering
            setupVirtualScrollObserver();
        }

        function setupVirtualScrollObserver() {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const section = entry.target;
                        // Highlight code blocks when section becomes visible
                        section.querySelectorAll('pre code[class*="language-"]:not(.prism-highlighted)').forEach(block => {
                            applySyntaxHighlightingToBlock(block);
                            block.classList.add('prism-highlighted');
                        });
                    }
                });
            }, {
                rootMargin: '100px',
                threshold: 0.1
            });

            preview.querySelectorAll('.preview-section').forEach(section => {
                observer.observe(section);
            });
        }

        // ============================================
        // LAZY PRISM LANGUAGE LOADING
        // ============================================

        function applySyntaxHighlighting() {
            if (typeof Prism === 'undefined') {
                console.warn('Prism is not loaded - syntax highlighting disabled');
                return;
            }

            // Find all code blocks with language classes
            const codeBlocks = preview.querySelectorAll('pre code[class*="language-"]');
            
            // Collect unique languages needed
            const languagesNeeded = new Set();
            codeBlocks.forEach(block => {
                const langClass = Array.from(block.classList).find(c => c.startsWith('language-'));
                if (langClass) {
                    const lang = langClass.replace('language-', '');
                    const normalizedLang = PRISM_LANGUAGE_MAP[lang] || lang;
                    if (!loadedPrismLanguages.has(normalizedLang) && !Prism.languages[normalizedLang]) {
                        languagesNeeded.add(normalizedLang);
                    }
                }
            });

            // Load missing languages, then highlight
            if (languagesNeeded.size > 0) {
                loadPrismLanguages([...languagesNeeded]).then(() => {
                    highlightAllCodeBlocks();
                });
            } else {
                highlightAllCodeBlocks();
            }

            // Handle code blocks without language class
            preview.querySelectorAll('pre code:not([class*="language-"])').forEach(block => {
                block.classList.add('language-plaintext');
            });
        }

        async function loadPrismLanguages(languages) {
            const basePath = '../js/vendor/markdown_preview/';
            
            for (const lang of languages) {
                if (loadedPrismLanguages.has(lang) || Prism.languages[lang]) {
                    continue;
                }
                
                try {
                    // Try to load the language file
                    await loadScript(`${basePath}prism-${lang}.min.js`);
                    loadedPrismLanguages.add(lang);
                } catch (err) {
                    // Language file doesn't exist or failed to load
                    console.warn(`Could not load Prism language: ${lang}`);
                    loadedPrismLanguages.add(lang); // Mark as attempted
                }
            }
        }

        function loadScript(src) {
            return new Promise((resolve, reject) => {
                // Check if already loaded
                if (document.querySelector(`script[src="${src}"]`)) {
                    resolve();
                    return;
                }
                
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function highlightAllCodeBlocks() {
            preview.querySelectorAll('pre code[class*="language-"]').forEach(block => {
                applySyntaxHighlightingToBlock(block);
            });
        }

        function applySyntaxHighlightingToBlock(block) {
            if (typeof Prism !== 'undefined') {
                try {
                    Prism.highlightElement(block);
                } catch (err) {
                    // Fallback if language not supported
                    console.warn('Prism highlight error:', err);
                }
            }
        }

        function hardenLinks(container) {
            container.querySelectorAll('a').forEach(link => {
                link.setAttribute('target', '_blank');
                link.setAttribute('rel', 'noopener noreferrer');
            });
        }

        function hardenImages(container) {
            container.querySelectorAll('img').forEach(img => {
                const src = img.getAttribute('src') || '';
                if (!src.match(/^(https?:|blob:)/i)) {
                    img.removeAttribute('src');
                    img.alt = '[Invalid image source]';
                }
            });
        }

        function mapLocalImages(html) {
            return html.replace(/src="local:\/\/([^"]+)"/g, (match, id) => {
                const img = uploadedImages.get(id);
                if (img) {
                    return `src="${img.objectUrl}"`;
                } else {
                    return `src="" data-missing-local="${id}"`;
                }
            });
        }

        function debouncedRender() {
            clearTimeout(renderTimer);
            renderTimer = setTimeout(renderPreview, RENDER_DEBOUNCE);
        }

        function scheduleAutosave() {
            clearTimeout(autosaveTimer);
            autosaveTimer = setTimeout(autosave, AUTOSAVE_DEBOUNCE);
        }
        // ============================================
        // PERFORMANCE MONITORING
        // ============================================

        function updateRenderStats(elapsed) {
            const ms = Math.round(elapsed);
            statRender.textContent = `${ms}ms`;
            renderTimeDisplay.textContent = `${ms}ms`;
        }

        function checkPerformance(elapsed) {
            renderTimes.push(elapsed);
            if (renderTimes.length > RENDER_HISTORY_SIZE) {
                renderTimes.shift();
            }

            const avg = renderTimes.reduce((a, b) => a + b, 0) / renderTimes.length;

            if (avg > SLOW_THRESHOLD_MS && !experimentalMode && livePreviewEnabled) {
                disableLivePreview();
                showWarning('Live preview disabled due to performance. Use "Update" button or enable Experimental Mode.');
            }
        }

        function disableLivePreview() {
            livePreviewEnabled = false;
            livePreviewToggle.checked = false;
            updateLivePreviewUI();
        }

        function updateLivePreviewUI() {
            livePreviewLabel.textContent = livePreviewEnabled ? 'Live Preview' : 'Live Preview (paused)';
            statLive.textContent = livePreviewEnabled ? 'ON' : 'OFF';
            updatePreviewBtn.style.display = livePreviewEnabled ? 'none' : 'flex';
        }

        function generateUUID() {
            if (crypto.randomUUID) {
                return crypto.randomUUID();
            }
            // Fallback for older browsers
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        // ============================================
        // MODE & TOGGLE HANDLERS
        // ============================================

        function setMode(mode, shouldRender = true) {
            const validModes = Object.keys(MODE_LABELS);
            if (!validModes.includes(mode)) {
                console.warn(`Invalid mode "${mode}", defaulting to commonmark`);
                mode = 'commonmark';
            }
            
            currentMode = mode;
            localStorage.setItem(STORAGE_KEYS.MODE, mode);

            // Update UI - toggle active class for all three mode buttons
            document.getElementById('modeOriginal').classList.toggle('active', mode === 'original');
            document.getElementById('modeCommonmark').classList.toggle('active', mode === 'commonmark');
            document.getElementById('modeGfm').classList.toggle('active', mode === 'gfm');
            
            // Update stats display using consolidated MODE_LABELS
            statMode.textContent = MODE_LABELS[mode] || mode;

            if (shouldRender) {
                renderPreview();
            }
        }

        function toggleLivePreview() {
            livePreviewEnabled = livePreviewToggle.checked;
            localStorage.setItem(STORAGE_KEYS.LIVE_PREVIEW, livePreviewEnabled);
            updateLivePreviewUI();

            if (livePreviewEnabled) {
                hideWarning();
                renderPreview();
            }
        }

        function toggleExperimental() {
            experimentalMode = experimentalToggle.checked;
            localStorage.setItem(STORAGE_KEYS.EXPERIMENTAL, experimentalMode);

            if (experimentalMode) {
                hideWarning();
            }
        }

        // ============================================
        // INSERT FORMATTING
        // ============================================

        function insertFormatting(type) {
            // Ensure editor has focus and get selection
            editor.focus();
            
            const start = editor.selectionStart;
            const end = editor.selectionEnd;
            const text = editor.value;
            const selectedText = text.substring(start, end);
            
            // Save state for undo
            saveSnapshot();
            
            const formats = {
                bold:      { prefix: '**', suffix: '**' },
                italic:    { prefix: '*',  suffix: '*' },
                code:      { prefix: '`',  suffix: '`' },
                codeblock: { prefix: '```\n', suffix: '\n```' },
                link:      { prefix: '[', suffix: '](url)' },
                image:     { prefix: '![', suffix: '](url)' },
                heading:   { prefix: '## ', suffix: '' },
                quote:     { prefix: '> ', suffix: '' },
                task:      { prefix: '- [ ] ', suffix: '' },
                strike:    { prefix: '~~', suffix: '~~' }
            };
            
            const fmt = formats[type];
            if (!fmt) return;
            
            let newValue = text;
            let newStart = start;
            let newEnd = end;
            let action = 'applied';
            
            // Check if selection is already wrapped with this formatting (markers outside selection)
            const beforeStart = start - fmt.prefix.length;
            const afterEnd = end + fmt.suffix.length;
            
            if (beforeStart >= 0 && afterEnd <= text.length && fmt.suffix) {
                const prefixBefore = text.substring(beforeStart, start);
                const suffixAfter = text.substring(end, afterEnd);
                
                if (prefixBefore === fmt.prefix && suffixAfter === fmt.suffix) {
                    // Remove formatting (markers are outside selection)
                    newValue = text.substring(0, beforeStart) + selectedText + text.substring(afterEnd);
                    newStart = beforeStart;
                    newEnd = beforeStart + selectedText.length;
                    action = 'removed';
                }
            }
            
            // Check if selected text itself contains the markers (markers inside selection)
            if (action === 'applied' && fmt.suffix && selectedText.length >= fmt.prefix.length + fmt.suffix.length) {
                if (selectedText.startsWith(fmt.prefix) && selectedText.endsWith(fmt.suffix)) {
                    const unwrapped = selectedText.slice(fmt.prefix.length, -fmt.suffix.length);
                    newValue = text.substring(0, start) + unwrapped + text.substring(end);
                    newStart = start;
                    newEnd = start + unwrapped.length;
                    action = 'removed';
                }
            }
            
            // If not removing, add formatting
            if (action === 'applied') {
                const placeholder = selectedText || 'text';
                const newText = fmt.prefix + placeholder + fmt.suffix;
                
                newValue = text.substring(0, start) + newText + text.substring(end);
                
                if (!selectedText) {
                    // No selection: select the placeholder
                    newStart = start + fmt.prefix.length;
                    newEnd = start + fmt.prefix.length + placeholder.length;
                } else {
                    // Had selection: select the wrapped text
                    newStart = start;
                    newEnd = start + newText.length;
                }
            }
            
            // Apply the change
            editor.value = newValue;
            editor.setSelectionRange(newStart, newEnd);
            
            // Show feedback
            showToast(`${action === 'removed' ? 'Removed' : 'Applied'} ${type}`, 'success');
            
            // Trigger updates
            closeDropdowns();
            
            if (livePreviewEnabled) {
                debouncedRender();
            }
            scheduleAutosave();
            updateStats();
        }

        function insertAtCursor(textarea, text) {
            const start = textarea.selectionStart;
            const before = textarea.value.substring(0, start);
            const after = textarea.value.substring(textarea.selectionEnd);

            textarea.value = before + text + after;

            const newPos = start + text.length;
            textarea.setSelectionRange(newPos, newPos);
        }

        // ============================================
        // COPY FUNCTIONS
        // ============================================

        function copyMarkdown() {
            const text = editor.value;
            if (!text) {
                showToast('Nothing to copy', 'warning');
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showToast('Markdown copied to clipboard', 'success');
            }).catch(() => {
                showToast('Copy failed. Please select and copy manually.', 'error');
            });
        }

        function copyHtml() {
            const html = preview.innerHTML;
            if (!html || preview.querySelector('.preview-placeholder')) {
                showToast('Nothing to copy', 'warning');
                return;
            }

            navigator.clipboard.writeText(html).then(() => {
                showToast('HTML copied to clipboard', 'success');
            }).catch(() => {
                showToast('Copy failed. Please select and copy manually.', 'error');
            });
        }

        // ============================================
        // DOWNLOAD FUNCTIONS
        // ============================================

        function showDownloadModal(type) {
            pendingDownloadType = type;
            document.getElementById('filenameInput').value = 'markdown';
            document.getElementById('filenameExt').textContent = '.' + type;
            document.getElementById('downloadModal').classList.add('active');
            document.getElementById('filenameInput').focus();
            document.getElementById('filenameInput').select();
        }

        function confirmDownload() {
            let filename = document.getElementById('filenameInput').value.trim() || 'markdown';
            
            // Sanitize filename - remove dangerous characters
            filename = sanitizeFilename(filename);
            
            if (!filename) {
                showToast('Invalid filename', 'error');
                return;
            }
            
            closeModal('downloadModal');

            if (pendingDownloadType === 'md') {
                downloadMarkdown(filename);
            } else if (pendingDownloadType === 'html') {
                downloadHtml(filename);
            }
        }

        function sanitizeFilename(filename) {
            // Remove path traversal attempts
            filename = filename.replace(/\.\./g, '');
            
            // Remove directory separators
            filename = filename.replace(/[\/\\]/g, '');
            
            // Remove other dangerous characters
            filename = filename.replace(/[<>:"|?*\x00-\x1f]/g, '');
            
            // Trim whitespace and dots from start/end
            filename = filename.replace(/^[\s.]+|[\s.]+$/g, '');
            
            // Limit length
            if (filename.length > 200) {
                filename = filename.substring(0, 200);
            }
            
            // Ensure it's not empty after sanitization
            return filename || 'document';
        }

        function downloadMarkdown(filename) {
            const text = editor.value;
            const blob = new Blob([text], { type: 'text/markdown;charset=utf-8' });
            downloadBlob(blob, `${filename}.md`);
            showToast('Markdown file downloaded', 'success');
        }

        function downloadHtml(filename) {
            const title = extractTitle() || 'Markdown Preview';
            const content = preview.innerHTML;
            const theme = document.documentElement.getAttribute('data-theme') || 'dark';

            const html = `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${escapeHtml(title)}</title>
    <style>
        ${getEmbeddedStyles(theme)}
    </style>
</head>
<body>
    <article class="markdown-body">
        ${content}
    </article>
</body>
</html>`;

            const blob = new Blob([html], { type: 'text/html;charset=utf-8' });
            downloadBlob(blob, `${filename}.html`);
            showToast('HTML file downloaded', 'success');
        }

        function downloadBlob(blob, filename) {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function extractTitle() {
            const h1 = preview.querySelector('h1');
            return h1 ? h1.textContent : null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function getEmbeddedStyles(theme) {
            // Memoization - return cached result if available
            if (embeddedStylesCache.has(theme)) {
                return embeddedStylesCache.get(theme);
            }

            const isDark = theme === 'dark';
            const styles = `
                :root {
                    --bg-primary: ${isDark ? '#0a0a0b' : '#f8f9fa'};
                    --bg-secondary: ${isDark ? '#111113' : '#ffffff'};
                    --text-primary: ${isDark ? '#fafafa' : '#0f172a'};
                    --text-secondary: ${isDark ? '#a1a1aa' : '#475569'};
                    --border-color: ${isDark ? '#27272a' : '#e2e8f0'};
                    --accent-color: ${isDark ? '#06b6d4' : '#0891b2'};
                }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: var(--bg-primary);
                    color: var(--text-primary);
                    line-height: 1.7;
                    margin: 0;
                    padding: 40px;
                }
                .markdown-body {
                    max-width: 800px;
                    margin: 0 auto;
                }
                h1, h2, h3, h4, h5, h6 { margin-top: 1.5em; margin-bottom: 0.5em; font-weight: 600; }
                h1 { font-size: 2rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
                h2 { font-size: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 0.3em; }
                p { margin: 0 0 1em 0; }
                a { color: var(--accent-color); text-decoration: none; }
                a:hover { text-decoration: underline; }
                code { font-family: monospace; background: var(--bg-secondary); padding: 0.2em 0.4em; border-radius: 4px; }
                pre { background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; overflow-x: auto; }
                pre code { background: none; padding: 0; }
                blockquote { margin: 1em 0; padding: 0.5em 1em; border-left: 4px solid var(--accent-color); background: var(--bg-secondary); }
                ul, ol { margin: 1em 0; padding-left: 2em; }
                table { width: 100%; border-collapse: collapse; margin: 1em 0; }
                th, td { border: 1px solid var(--border-color); padding: 8px 12px; text-align: left; }
                th { background: var(--bg-secondary); font-weight: 600; }
                img { max-width: 100%; height: auto; }
                hr { border: none; border-top: 1px solid var(--border-color); margin: 2em 0; }
                @media print {
                    body { padding: 0; }
                    pre { white-space: pre-wrap; }
                }
            `;

            // Cache the result
            embeddedStylesCache.set(theme, styles);
            return styles;
        }

        // ============================================
        // PRINT
        // ============================================

        function printPreview() {
            const title = extractTitle() || 'Markdown Preview';
            const content = preview.innerHTML;

            const printWindow = window.open('', '_blank');

            if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
                showToast('Popup blocked. Please allow popups for printing, or use Ctrl+P.', 'warning');
                return;
            }
            printWindow.document.write(`<!DOCTYPE html>
<html>
<head>
    <title>${escapeHtml(title)}</title>
    <style>
        ${getEmbeddedStyles('light')}
        @media print {
            body { margin: 0; padding: 20px; }
            pre { white-space: pre-wrap; word-break: break-word; }
            img { max-width: 100%; page-break-inside: avoid; }
            h1, h2, h3 { page-break-after: avoid; }
        }
    </style>
</head>
<body>
    <article class="markdown-body">
        ${content}
    </article>
    <script>window.onload = () => { window.print(); }<\/script>
</body>
</html>`);
            printWindow.document.close();
        }

        // ============================================
        // CLEAR FUNCTION
        // ============================================

        function showClearModal() {
            if (editor.value.length === 0) {
                showToast('Editor is already empty', 'warning');
                return;
            }

            if (editor.value.length < CLEAR_MODAL_THRESHOLD) {
                confirmClear();
                return;
            }

            document.getElementById('clearCharCount').textContent = editor.value.length.toLocaleString() + ' characters';
            document.getElementById('clearModal').classList.add('active');
        }

        function confirmClear() {
            editor.value = '';
            lastSavedContent = '';
            hasUnsavedChanges = false;
            localStorage.removeItem(STORAGE_KEYS.DRAFT);
            localStorage.removeItem(STORAGE_KEYS.MISSING_IMAGES);
            updateStats();
            renderPreview();
            closeModal('clearModal');
            hideWarning();
            showToast('Document cleared', 'success');
        }

        // ============================================
        // MODALS
        // ============================================

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function closeAllModals() {
            document.querySelectorAll('.modal-overlay').forEach(m => m.classList.remove('active'));
            insertDropdown.classList.remove('active');
        }

        // ============================================
        // IMAGE HANDLING
        // ============================================

        function handleImageUpload(files) {
            for (const file of files) {
                // Type check
                if (!['image/png', 'image/jpeg', 'image/gif', 'image/webp'].includes(file.type)) {
                    if (file.type === 'image/svg+xml') {
                        showToast('SVG files are not supported due to security restrictions. Please convert to PNG or JPG.', 'error');
                    } else {
                        showToast(`${file.name}: Only PNG, JPG, GIF, WebP allowed`, 'error');
                    }
                    continue;
                }

                // Size check
                if (file.size > MAX_IMAGE_SIZE) {
                    showToast(`${file.name}: Exceeds 10MB limit`, 'error');
                    continue;
                }

                // Total session check
                const currentTotal = [...uploadedImages.values()].reduce((sum, img) => sum + img.size, 0);
                if (currentTotal + file.size > MAX_SESSION_STORAGE) {
                    showToast('Session image storage limit (50MB) reached', 'error');
                    break;
                }

                const id = generateUUID();
                const objectUrl = URL.createObjectURL(file);
                uploadedImages.set(id, { file, objectUrl, name: file.name, size: file.size });
            }

            renderImageList();
            updateStorageInfo();
        }

        function renderImageList() {
            if (uploadedImages.size === 0) {
                imageList.innerHTML = '';
                return;
            }

            imageList.innerHTML = [...uploadedImages.entries()].map(([id, img]) => `
                <div class="image-item">
                    <img src="${img.objectUrl}" alt="${escapeHtml(img.name)}">
                    <div class="image-item-info">
                        <div class="image-item-name">${escapeHtml(img.name)}</div>
                        <div class="image-item-size">${formatBytes(img.size)}</div>
                    </div>
                    <div class="image-item-actions">
                        <button class="image-item-btn" onclick="insertImageMarkdown('${id}')">Insert</button>
                        <button class="image-item-btn delete" onclick="removeImage('${id}')">X</button>
                    </div>
                </div>
            `).join('');
        }

        function insertImageMarkdown(id) {
            const img = uploadedImages.get(id);
            if (!img) return;

            const markdown = `![${img.name}](local://${id})`;
            insertAtCursor(editor, markdown);
            editor.focus();
            onEditorInput({ inputType: 'insertText', data: '' });
        }

        function removeImage(id) {
            const img = uploadedImages.get(id);
            if (img) {
                URL.revokeObjectURL(img.objectUrl);
            }
            uploadedImages.delete(id);
            renderImageList();
            updateStorageInfo();
            renderPreview();
        }

        function updateStorageInfo() {
            const total = [...uploadedImages.values()].reduce((sum, img) => sum + img.size, 0);
            storageInfo.textContent = `Session storage: ${formatBytes(total)} / 50 MB`;
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 KB';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
        }

        // ============================================
        // AUTOSAVE
        // ============================================

        function autosave() {
            const text = editor.value;
            const bytes = new Blob([text]).size;

            if (bytes > MAX_DRAFT_BYTES || text.length > MAX_DRAFT_CHARS) {
                updateAutosaveStatus('warning', 'Draft too large to autosave (limit: 1MB)');
                return;
            }

            try {
                localStorage.setItem(STORAGE_KEYS.DRAFT, text);

                // Save list of local image filenames for missing image warning
                const localImageMatches = text.match(/local:\/\/([^)]+)/g) || [];
                const imageNames = localImageMatches.map(match => {
                    const id = match.replace('local://', '');
                    const img = uploadedImages.get(id);
                    return img ? img.name : 'unknown';
                }).filter(name => name !== 'unknown');
                localStorage.setItem(STORAGE_KEYS.MISSING_IMAGES, JSON.stringify(imageNames));

                lastSavedContent = text;
                lastSaveTime = new Date();
                hasUnsavedChanges = false;
                updateAutosaveStatus('saved');
            } catch (e) {
                updateAutosaveStatus('error', 'Storage quota exceeded');
            }
        }

        function updateAutosaveStatus(status, message = '') {
            if (status === 'saved') {
                statusDot.className = 'status-dot';
                statusText.textContent = 'Saved';
                statusTime.textContent = 'Last: Just now';
            } else if (status === 'warning') {
                statusDot.className = 'status-dot warning';
                statusText.textContent = 'Paused';
                statusTime.textContent = message;
            } else if (status === 'error') {
                statusDot.className = 'status-dot error';
                statusText.textContent = 'Error';
                statusTime.textContent = message;
            }
        }

        function clearDraft() {
            localStorage.removeItem(STORAGE_KEYS.DRAFT);
            localStorage.removeItem(STORAGE_KEYS.MISSING_IMAGES);
            lastSavedContent = '';
            showToast('Saved draft cleared', 'success');
            updateAutosaveStatus('saved');
            statusTime.textContent = 'No saved draft';
        }

        // ============================================
        // STATS
        // ============================================

        function updateStats() {
            const content = editor.value;
            const chars = content.length;
            const words = content.trim() ? content.trim().split(/\s+/).length : 0;
            const lines = content ? content.split('\n').length : 0;
            
            // Calculate reading time using constant
            const readingTimeMinutes = Math.ceil(words / WORDS_PER_MINUTE);
            const readingTimeText = readingTimeMinutes === 0 ? '< 1 min' 
                : readingTimeMinutes === 1 ? '1 min' 
                : `${readingTimeMinutes} min`;
            
            statChars.textContent = chars.toLocaleString();
            statWords.textContent = words.toLocaleString();
            statLines.textContent = lines.toLocaleString();
            statReadTime.textContent = readingTimeText;
            statLive.textContent = livePreviewEnabled ? 'ON' : 'OFF';
            
            // Use consolidated MODE_LABELS constant
            statMode.textContent = MODE_LABELS[currentMode] || currentMode;
        }

        // ============================================
        // WARNING BANNER
        // ============================================

        function showWarning(message) {
            warningText.textContent = message;
            warningBanner.classList.remove('hidden');
        }

        function hideWarning() {
            warningBanner.classList.add('hidden');
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================

        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            const svgContent = type === 'success' 
                ? '<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>' 
                : type === 'error' 
                    ? '<circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/>' 
                    : '<path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/>';
            
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('viewBox', '0 0 24 24');
            svg.setAttribute('width', '16');
            svg.setAttribute('height', '16');
            svg.setAttribute('fill', 'none');
            svg.setAttribute('stroke', 'currentColor');
            svg.setAttribute('stroke-width', '2');
            svg.innerHTML = svgContent;
            
            const textNode = document.createTextNode(message);
            
            toast.appendChild(svg);
            toast.appendChild(textNode);
            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => toast.remove(), TOAST_FADE_DURATION);
            }, TOAST_DURATION);
        }

// SAMPLE CONTENT
// ============================================

const SAMPLE_MARKDOWN = {
    // CommonMark: no tables / task-lists (keeps fences)
    commonmark: `# 1,3-Propanediol (1,3-PDO) Production via *Lactobacillus reuteri* CH53 (Fed-Batch Fermentation)

A process description for producing **1,3-propanediol (1,3-PDO)** from **crude glycerol** using an anaerobic, fed-batch fermentation train with downstream **biomass removal**, **water removal**, and **multi-column distillation** to reach ~**99.5%** product purity.

## Overview

This chosen route produces 1,3-PDO by **microbial glycerol fermentation** using *Lactobacillus reuteri* CH53 under **anaerobic conditions**. The end-to-end process has four major steps:

1. **Preparation** (media blending + sterilization + splitting to seed fermentors)
2. **Fermentation** (seed train -> product fermentor)
3. **Biomass separation** (hydrocyclones -> ultrafiltration)
4. **Distillation** (after reverse osmosis water removal)

> Key idea: fermentation broth is clarified (remove cells), concentrated (remove water), then fractionated (distillation) to isolate 1,3-PDO and co-products.

---

## Feedstocks & Utilities

### Required Inputs (table-free)

- **Carbon — Crude glycerol:** Primary substrate for 1,3-PDO formation
- **Carbon — Glucose (sugar solution):** Co-substrate / electron acceptor (co-fermentation)
- **Nitrogen + nutrients — Corn steep liquor (CSL):** Nitrogen source + nutrients (incl. vitamin B12 in the media context)
- **Utilities — Water (fresh + recycle):** Media prep; significant recycle from water removal
- **Utilities — Nitrogen gas (N₂):** Maintain anaerobic conditions; purge dissolved O₂
- **pH control — NaOH / H₂SO₄:** Split-range pH control around setpoint
- **(Optional upstream) Enzymes — Cellulase + β-glucosidase:** Used if producing glucose from corn stover (on-demand option)

### Quality Control Checklist (no task-list syntax)

- ✅ Confirm sterilization cycle completed for media streams (CSL + carbon mix)
- ✅ Verify **pH probe** calibrated; setpoint **pH = 5.5**
- ✅ Verify **dissolved O₂** sensor functional (target near 0% O₂)
- ✅ Confirm N₂ sparge available at target flow (e.g., vvm basis)
- ⬜ Verify seed inoculum viability and **OD₆₀₀** trending toward target
- ⬜ Confirm recycle water routing/valving to blending tanks is enabled

---

## Process Steps

## 1) Preparation (Media Blending + Sterilization + Split)

**Goal:** prepare two sterile media streams (CSL solution; glycerol+glucose solution), then split into staged seed fermentors and the product fermentor.

**High-level sequence:**

\`\`\`
1. Blend CSL + water (ambient)
2. Heat-sterilize CSL stream (high temperature) and cool to fermentation temperature
3. Blend glycerol + glucose + water (note: much water may come from recycle)
4. Heat-sterilize carbon stream and transfer to storage
5. Split sterile media into 4 streams: 90 : 9 : 0.9 : 0.1
   - 0.1% -> Seed 1
   - 0.9% -> Seed 2
   - 9%   -> Seed 3
   - 90%  -> Product fermentor
\`\`\`

**Notes**
- The split is typically implemented with flow measurement + ratio control to maintain the target proportions.
- Sterility is a major risk driver; contamination can ruin a batch.

---

## 2) Fermentation (Seed Train -> Product Fermentor)

**Goal:** scale inoculum through multiple seed fermentors, then run production fermentation in the main fermentor.

### Operating Targets (table-free)

- **Seed fermentors (Fed-batch)**  
  - Temperature: **98.6 °F**  
  - Pressure: **14.7 psia**  
  - pH: **5.5**  
  - Agitation: **100 rpm**  
  - Duration: **~9 hr each**
- **Product fermentor (Fed-batch)**  
  - Temperature: **98.6 °F**  
  - Pressure: **14.7 psia**  
  - pH: **5.5**  
  - Agitation: **(scale-dependent)**  
  - Duration: **~24 hr**

### Substrate ratio

Maintain a **molar ratio (glucose : glycerol) = 0.5** for the mixed feed stream.

### Anaerobic control

During incubation, sparge **N₂** to maintain anaerobic conditions and strip dissolved oxygen.

\`\`\`
If dissolved O₂ rises:
  - Increase N₂ purge flow
  - Check foaming / agitation / seal integrity
  - Verify O₂ sensor (Clark electrode) response
\`\`\`

---

## 3) Biomass Separation (Hydrocyclones -> Ultrafiltration)

**Goal:** remove biomass (cells) from the fermentation broth before downstream concentration and distillation.

### 3A) Hydrocyclones

- Broth is pumped to hydrocyclones to stabilize **inlet flowrate/pressure**.
- Typical feed stream water content can be ~70%.
- Underflow biomass slurry can be routed for disposal or reuse (e.g., drying for fuel stock / feed).

**Hydrocyclone power heuristic (as used in the write-up):**

\`\`\`
Power Output ≈ Flowrate * Pressure Drop
\`\`\`

### 3B) Ultrafiltration

- Removes remaining biomass particles not captured by hydrocyclones.
- Key controls: pressure across the filter (manage ∆P), and crossflow velocity (tradeoff: purity vs flux).

---

## 4) Water Removal (Reverse Osmosis)

**Goal:** remove most remaining water to reduce distillation load and improve economics.

Key monitored variables typically include:
- inlet flowrate & pressure (protect membrane)
- pH (limit precipitation/fouling)
- recovery rate (targeting very high water removal)
- permeate flowrate

**Recycle:** permeate water is routed back to the blending tanks as a recycle stream.

---

## 5) Distillation Train (3 Columns)

**Goal:** reach high product purity for 1,3-PDO and recover co-products.

### Column Operating Conditions (table-free)

- **Column 1**  
  - Pressure: **2.18 psia**  
  - Top Temp: **164 °F** -> Top Product: **Light products (ethanol + acetic acid)**  
  - Bottom Temp: **323 °F** -> Bottom Product: **Heavy (lactic acid + 1,3-PDO)**
- **Column 2**  
  - Pressure: **2.18 psia**  
  - Top Temp: **97.7 °F** -> Top Product: **Ethanol**  
  - Bottom Temp: **148.9 °F** -> Bottom Product: **Acetic acid**
- **Column 3**  
  - Pressure: **2.18 psia**  
  - Top Temp: **286.3 °F** -> Top Product: **1,3-PDO**  
  - Bottom Temp: **310.7 °F** -> Bottom Product: **Lactic acid**

### Example Product Purities (targets/outcomes)

- **1,3-PDO:** ~99.54% (Column 3 top)
- **Lactic acid:** ~98.16% (Column 3 bottom)
- **Ethanol:** ~99.9999% (Column 2 top)
- **Acetic acid:** ~99.16% (Column 2 bottom)

---

## Expected Results

Typical performance targets for the chosen fermentation route include:

- Conversion/yield basis example: **0.82 g 1,3-PDO / g glycerol**
- Broth concentration example: **~68 g/L 1,3-PDO**
- Productivity example: **~1.27 g/L/hr**
- Final product purity target: **~99.5% 1,3-PDO** via distillation

Validate by:
- compositional analysis of distillate streams (GC/HPLC as appropriate)
- mass balance closure across RO + distillation
- fermentation KPIs (OD₆₀₀ trends, substrate consumption, byproduct profile)

---

## Risks & Operational Notes

- **Contamination risk**: sterilization and closed handling are critical.
- **Strain drift/mutation**: maintain consistent cell banking and seed management.
- **Membrane fouling**: ultrafiltration/RO performance is sensitive to solids, pH, and precipitation.
- **Control complexity**: pH, temperature, anaerobic conditions, and flow splitting all require robust instrumentation.

---

*Example derived from a UIC Chemical Engineering process description (Report #4).*
*Draft format intended for Markdown preview tooling and documentation demos.*`,

    // GFM: keep tables, task list, fences 
    gfm: `# 1,3-Propanediol (1,3-PDO) Production via *Lactobacillus reuteri* CH53 (Fed-Batch Fermentation)

A process description for producing **1,3-propanediol (1,3-PDO)** from **crude glycerol** using an anaerobic, fed-batch fermentation train with downstream **biomass removal**, **water removal**, and **multi-column distillation** to reach ~**99.5%** product purity.

## Overview

This chosen route produces 1,3-PDO by **microbial glycerol fermentation** using *Lactobacillus reuteri* CH53 under **anaerobic conditions**. The end-to-end process has four major steps:

1. **Preparation** (media blending + sterilization + splitting to seed fermentors)
2. **Fermentation** (seed train -> product fermentor)
3. **Biomass separation** (hydrocyclones -> ultrafiltration)
4. **Distillation** (after reverse osmosis water removal)

> Key idea: fermentation broth is clarified (remove cells), concentrated (remove water), then fractionated (distillation) to isolate 1,3-PDO and co-products.

---

## Feedstocks & Utilities

### Required Inputs

| Category | Material | Purpose / Notes |
|---|---|---|
| Carbon | Crude glycerol | Primary substrate for 1,3-PDO formation |
| Carbon | Glucose (sugar solution) | Co-substrate / electron acceptor (co-fermentation) |
| Nitrogen + nutrients | Corn steep liquor (CSL) | Nitrogen source + nutrients (incl. vitamin B12 in the media context) |
| Utilities | Water (fresh + recycle) | Media prep; significant recycle from water removal |
| Utilities | Nitrogen gas (N₂) | Maintain anaerobic conditions; purge dissolved O₂ |
| pH control | NaOH / H₂SO₄ | Split-range pH control around setpoint |
| (Optional upstream) Enzymes | Cellulase + β-glucosidase | Used if producing glucose from corn stover (on-demand option) |

### Quality Control Checklist

- [x] Confirm sterilization cycle completed for media streams (CSL + carbon mix)
- [x] Verify **pH probe** calibrated; setpoint **pH = 5.5**
- [x] Verify **dissolved O₂** sensor functional (target near 0% O₂)
- [x] Confirm N₂ sparge available at target flow (e.g., vvm basis)
- [ ] Verify seed inoculum viability and **OD₆₀₀** trending toward target
- [ ] Confirm recycle water routing/valving to blending tanks is enabled

---

## Process Steps

## 1) Preparation (Media Blending + Sterilization + Split)

**Goal:** prepare two sterile media streams (CSL solution; glycerol+glucose solution), then split into staged seed fermentors and the product fermentor.

**High-level sequence:**

\`\`\`
1. Blend CSL + water (ambient)
2. Heat-sterilize CSL stream (high temperature) and cool to fermentation temperature
3. Blend glycerol + glucose + water (note: much water may come from recycle)
4. Heat-sterilize carbon stream and transfer to storage
5. Split sterile media into 4 streams: 90 : 9 : 0.9 : 0.1
   - 0.1% -> Seed 1
   - 0.9% -> Seed 2
   - 9%   -> Seed 3
   - 90%  -> Product fermentor
\`\`\`

**Notes**
- The split is typically implemented with flow measurement + ratio control to maintain the target proportions.
- Sterility is a major risk driver; contamination can ruin a batch.

---

## 2) Fermentation (Seed Train -> Product Fermentor)

**Goal:** scale inoculum through multiple seed fermentors, then run production fermentation in the main fermentor.

### Operating Targets (typical)

| Unit | Mode | Temperature | Pressure | pH | Agitation | Duration |
|---|---|---:|---:|---:|---:|---:|
| Seed fermentors | Fed-batch | 98.6 °F | 14.7 psia | 5.5 | 100 rpm | ~9 hr each |
| Product fermentor | Fed-batch | 98.6 °F | 14.7 psia | 5.5 | (scale-dependent) | ~24 hr |

### Substrate ratio

Maintain a **molar ratio (glucose : glycerol) = 0.5** for the mixed feed stream.

### Anaerobic control

During incubation, sparge **N₂** to maintain anaerobic conditions and strip dissolved oxygen.

\`\`\`
If dissolved O₂ rises:
  - Increase N₂ purge flow
  - Check foaming / agitation / seal integrity
  - Verify O₂ sensor (Clark electrode) response
\`\`\`

---

## 3) Biomass Separation (Hydrocyclones -> Ultrafiltration)

**Goal:** remove biomass (cells) from the fermentation broth before downstream concentration and distillation.

### 3A) Hydrocyclones

- Broth is pumped to hydrocyclones to stabilize **inlet flowrate/pressure**.
- Typical feed stream water content can be ~70%.
- Underflow biomass slurry can be routed for disposal or reuse (e.g., drying for fuel stock / feed).

**Hydrocyclone power heuristic (as used in the write-up):**

\`\`\`
Power Output ≈ Flowrate * Pressure Drop
\`\`\`

### 3B) Ultrafiltration

- Removes remaining biomass particles not captured by hydrocyclones.
- Key controls: pressure across the filter (manage ∆P), and crossflow velocity (tradeoff: purity vs flux).

---

## 4) Water Removal (Reverse Osmosis)

**Goal:** remove most remaining water to reduce distillation load and improve economics.

Key monitored variables typically include:
- inlet flowrate & pressure (protect membrane)
- pH (limit precipitation/fouling)
- recovery rate (targeting very high water removal)
- permeate flowrate

**Recycle:** permeate water is routed back to the blending tanks as a recycle stream.

---

## 5) Distillation Train (3 Columns)

**Goal:** reach high product purity for 1,3-PDO and recover co-products.

### Column Operating Conditions

| Column | Pressure | Top Temp | Bottom Temp | Top Product | Bottom Product |
|---|---:|---:|---:|---|---|
| Column 1 | 2.18 psia | 164 °F | 323 °F | Light products (ethanol + acetic acid) | Heavy (lactic acid + 1,3-PDO) |
| Column 2 | 2.18 psia | 97.7 °F | 148.9 °F | Ethanol | Acetic acid |
| Column 3 | 2.18 psia | 286.3 °F | 310.7 °F | 1,3-PDO | Lactic acid |

### Example Product Purities (targets/outcomes)

- **1,3-PDO:** ~99.54% (Column 3 top)
- **Lactic acid:** ~98.16% (Column 3 bottom)
- **Ethanol:** ~99.9999% (Column 2 top)
- **Acetic acid:** ~99.16% (Column 2 bottom)

---

## Expected Results

Typical performance targets for the chosen fermentation route include:

- Conversion/yield basis example: **0.82 g 1,3-PDO / g glycerol**
- Broth concentration example: **~68 g/L 1,3-PDO**
- Productivity example: **~1.27 g/L/hr**
- Final product purity target: **~99.5% 1,3-PDO** via distillation

Validate by:
- compositional analysis of distillate streams (GC/HPLC as appropriate)
- mass balance closure across RO + distillation
- fermentation KPIs (OD₆₀₀(Optical Density) trends, substrate consumption, byproduct profile)

---

## Risks & Operational Notes

- **Contamination risk**: sterilization and closed handling are critical.
- **Strain drift/mutation**: maintain consistent cell banking and seed management.
- **Membrane fouling**: ultrafiltration/RO performance is sensitive to solids, pH, and precipitation.
- **Control complexity**: pH, temperature, anaerobic conditions, and flow splitting all require robust instrumentation.

---

*Example derived from a UIC Chemical Engineering process description (Report #4).*
*Draft format intended for Markdown preview tooling and documentation demos.*`,

    // Markdown 1.0: no tables / task-lists; avoid fenced blocks (use indented code blocks)
    original: `# 1,3-Propanediol (1,3-PDO) Production via *Lactobacillus reuteri* CH53 (Fed-Batch Fermentation)

A process description for producing **1,3-propanediol (1,3-PDO)** from **crude glycerol** using an anaerobic, fed-batch fermentation train with downstream **biomass removal**, **water removal**, and **multi-column distillation** to reach ~**99.5%** product purity.

## Overview

This chosen route produces 1,3-PDO by **microbial glycerol fermentation** using *Lactobacillus reuteri* CH53 under **anaerobic conditions**. The end-to-end process has four major steps:

1. **Preparation** (media blending + sterilization + splitting to seed fermentors)
2. **Fermentation** (seed train -> product fermentor)
3. **Biomass separation** (hydrocyclones -> ultrafiltration)
4. **Distillation** (after reverse osmosis water removal)

> Key idea: fermentation broth is clarified (remove cells), concentrated (remove water), then fractionated (distillation) to isolate 1,3-PDO and co-products.

---

## Feedstocks & Utilities

### Required Inputs (table-free)

- **Carbon:** Crude glycerol - Primary substrate for 1,3-PDO formation
- **Carbon:** Glucose (sugar solution) - Co-substrate / electron acceptor (co-fermentation)
- **Nitrogen + nutrients:** Corn steep liquor (CSL) - Nitrogen source + nutrients (incl. vitamin B12 in the media context)
- **Utilities:** Water (fresh + recycle) - Media prep; significant recycle from water removal
- **Utilities:** Nitrogen gas (N₂) - Maintain anaerobic conditions; purge dissolved O₂
- **pH control:** NaOH / H₂SO₄ - Split-range pH control around setpoint
- **(Optional upstream) Enzymes:** Cellulase + β-glucosidase — Used if producing glucose from corn stover (on-demand option)

### Quality Control Checklist (no task-list syntax)

- DONE: Confirm sterilization cycle completed for media streams (CSL + carbon mix)
- DONE: Verify **pH probe** calibrated; setpoint **pH = 5.5**
- DONE: Verify **dissolved O₂** sensor functional (target near 0% O₂)
- DONE: Confirm N₂ sparge available at target flow (e.g., vvm basis)
- TODO: Verify seed inoculum viability and **OD₆₀₀** trending toward target
- TODO: Confirm recycle water routing/valving to blending tanks is enabled

---

## Process Steps

## 1) Preparation (Media Blending + Sterilization + Split)

**Goal:** prepare two sterile media streams (CSL solution; glycerol+glucose solution), then split into staged seed fermentors and the product fermentor.

**High-level sequence:**

    1. Blend CSL + water (ambient)
    2. Heat-sterilize CSL stream (high temperature) and cool to fermentation temperature
    3. Blend glycerol + glucose + water (note: much water may come from recycle)
    4. Heat-sterilize carbon stream and transfer to storage
    5. Split sterile media into 4 streams: 90 : 9 : 0.9 : 0.1
       - 0.1% -> Seed 1
       - 0.9% -> Seed 2
       - 9%   -> Seed 3
       - 90%  -> Product fermentor

**Notes**
- The split is typically implemented with flow measurement + ratio control to maintain the target proportions.
- Sterility is a major risk driver; contamination can ruin a batch.

---

## 2) Fermentation (Seed Train -> Product Fermentor)

**Goal:** scale inoculum through multiple seed fermentors, then run production fermentation in the main fermentor.

### Operating Targets (table-free)

- **Seed fermentors (Fed-batch)**: 98.6 °F; 14.7 psia; pH 5.5; 100 rpm; ~9 hr each
- **Product fermentor (Fed-batch)**: 98.6 °F; 14.7 psia; pH 5.5; (scale-dependent agitation); ~24 hr

### Substrate ratio

Maintain a **molar ratio (glucose : glycerol) = 0.5** for the mixed feed stream.

### Anaerobic control

During incubation, sparge **N₂** to maintain anaerobic conditions and strip dissolved oxygen.

    If dissolved O₂ rises:
      - Increase N₂ purge flow
      - Check foaming / agitation / seal integrity
      - Verify O₂ sensor (Clark electrode) response

---

## 3) Biomass Separation (Hydrocyclones -> Ultrafiltration)

**Goal:** remove biomass (cells) from the fermentation broth before downstream concentration and distillation.

### 3A) Hydrocyclones

- Broth is pumped to hydrocyclones to stabilize **inlet flowrate/pressure**.
- Typical feed stream water content can be ~70%.
- Underflow biomass slurry can be routed for disposal or reuse (e.g., drying for fuel stock / feed).

**Hydrocyclone power heuristic (as used in the write-up):**

    Power Output ≈ Flowrate * Pressure Drop

### 3B) Ultrafiltration

- Removes remaining biomass particles not captured by hydrocyclones.
- Key controls: pressure across the filter (manage ∆P), and crossflow velocity (tradeoff: purity vs flux).

---

## 4) Water Removal (Reverse Osmosis)

**Goal:** remove most remaining water to reduce distillation load and improve economics.

Key monitored variables typically include:
- inlet flowrate & pressure (protect membrane)
- pH (limit precipitation/fouling)
- recovery rate (targeting very high water removal)
- permeate flowrate

**Recycle:** permeate water is routed back to the blending tanks as a recycle stream.

---

## 5) Distillation Train (3 Columns)

**Goal:** reach high product purity for 1,3-PDO and recover co-products.

### Column Operating Conditions (table-free)

- **Column 1 (2.18 psia)**: Top 164 °F -> Light products (ethanol + acetic acid); Bottom 323 °F -> Heavy (lactic acid + 1,3-PDO)
- **Column 2 (2.18 psia)**: Top 97.7 °F -> Ethanol; Bottom 148.9 °F -> Acetic acid
- **Column 3 (2.18 psia)**: Top 286.3 °F -> 1,3-PDO; Bottom 310.7 °F -> Lactic acid

### Example Product Purities (targets/outcomes)

- **1,3-PDO:** ~99.54% (Column 3 top)
- **Lactic acid:** ~98.16% (Column 3 bottom)
- **Ethanol:** ~99.9999% (Column 2 top)
- **Acetic acid:** ~99.16% (Column 2 bottom)

---

## Expected Results

Typical performance targets for the chosen fermentation route include:

- Conversion/yield basis example: **0.82 g 1,3-PDO / g glycerol**
- Broth concentration example: **~68 g/L 1,3-PDO**
- Productivity example: **~1.27 g/L/hr**
- Final product purity target: **~99.5% 1,3-PDO** via distillation

Validate by:
- compositional analysis of distillate streams (GC/HPLC as appropriate)
- mass balance closure across RO + distillation
- fermentation KPIs (OD₆₀₀ trends, substrate consumption, byproduct profile)

---

## Risks & Operational Notes

- **Contamination risk**: sterilization and closed handling are critical.
- **Strain drift/mutation**: maintain consistent cell banking and seed management.
- **Membrane fouling**: ultrafiltration/RO performance is sensitive to solids, pH, and precipitation.
- **Control complexity**: pH, temperature, anaerobic conditions, and flow splitting all require robust instrumentation.

---

*Example derived from a UIC Chemical Engineering process description (Report #4).*
*Draft format intended for Markdown preview tooling and documentation demos.*`
};

function loadSampleContent(mode = currentMode) {
    const targetMode = (mode && SAMPLE_MARKDOWN[mode]) ? mode : currentMode;

    // If they clicked a specific sample, switch the parser mode to match it.
    if (targetMode !== currentMode) {
        setMode(targetMode, false);
    }

    editor.value = SAMPLE_MARKDOWN[targetMode] || SAMPLE_MARKDOWN.commonmark;

    // Clear warnings, refresh preview/stats, and persist as the current saved draft.
    hideWarning();
    updateStats();
    renderPreview();

    // Save immediately so reload/refresh keeps the sample
    autosave();

    const modeLabel = (targetMode === 'original')
        ? 'MD 1.0'
        : (targetMode === 'gfm')
            ? 'GFM'
            : 'CommonMark';

    showToast(`Loaded ${modeLabel} sample`, 'success');
}

    </script>
</body>
</html>
